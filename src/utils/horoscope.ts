import { buildAstroHighlights } from './astro';
import type { AIRequestOptions, AIMessage } from './aiClient';
import { fetchDailyWeatherSummary, fetchWeeklyWeatherSummary } from './weather';
import { buildDailyCycleHint, buildSergeyCycleHint, buildWeeklyCycleHint } from './cyclePrompt';
import type { CycleData, HoroscopeMemoryEntry } from '../types';

export interface DailyHoroscope {
  text: string;
  date: string | null;
  provider?: 'claude' | 'openai' | 'fallback';
  weekRange?: string;
  highlights?: string[];
  memoryEntry?: HoroscopeMemoryEntry;
}

export interface HoroscopeLoadingMessage {
  emoji: string;
  text: string;
}

const SERGEY_FALLBACK_LEADS = [
  { emoji: 'ü™ê', lead: '–°–∞—Ç—É—Ä–Ω —Ñ—ã—Ä–∫–∞–µ—Ç:' },
  { emoji: 'üî•', lead: '–ú–∞—Ä—Å —Ö–º—É—Ä–∏—Ç—Å—è:' },
  { emoji: 'üåÄ', lead: '–Æ–ø–∏—Ç–µ—Ä –Ω–∞–±–ª—é–¥–∞–µ—Ç:' },
  { emoji: 'üíã', lead: '–í–µ–Ω–µ—Ä–∞ —É—Ö–º—ã–ª—è–µ—Ç—Å—è:' },
  { emoji: 'üì°', lead: '–ú–µ—Ä–∫—É—Ä–∏–π —à–µ–ø—á–µ—Ç:' },
  { emoji: '‚ö°Ô∏è', lead: '–£—Ä–∞–Ω –º–æ—Ä–≥–∞–µ—Ç:' },
  { emoji: 'üßä', lead: '–ù–µ–ø—Ç—É–Ω –≤–∑–¥—ã—Ö–∞–µ—Ç:' },
  { emoji: 'üßØ', lead: '–ü–ª—É—Ç–æ–Ω —â—ë–ª–∫–∞–µ—Ç –∑–∞–∂–∏–≥–∞–ª–∫–æ–π:' },
];

const SERGEY_FALLBACK_MIDDLES = [
  '–°–µ—Ä—ë–∂–∞ –æ–ø—è—Ç—å –ª–∏—Å—Ç–∞–µ—Ç —á–∞—Ç—ã',
  '–°–µ—Ä—ë–∂–∞ –ø–∏—à–µ—Ç –ø–ª–∞–Ω –Ω–æ–º–µ—Ä –≤–æ—Å–µ–º—å',
  '–°–µ—Ä—ë–∂–∞ –∫–∏–≤–∞–µ—Ç —Å –≤–∏–¥–æ–º —Å–ø–∞—Å–∏—Ç–µ–ª—è',
  '–°–µ—Ä—ë–∂–∞ –æ—Ç–¥–∏—Ä–∞–µ—Ç —Å—Ç–∏–∫–µ—Ä—ã –±–µ–∑ —Ü–µ–ª–∏',
  '–°–µ—Ä—ë–∂–∞ —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–æ–≤–µ—â–∞–Ω–∏–µ —Å –∑–µ—Ä–∫–∞–ª–æ–º',
  '–°–µ—Ä—ë–∂–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç—á—ë—Ç, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç',
  '–°–µ—Ä—ë–∂–∞ —Ç—Ä–µ–Ω–∏—Ä—É–µ—Ç –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–Ω—ã–π –≤–∑–≥–ª—è–¥',
  '–°–µ—Ä—ë–∂–∞ –∫–ª—è–Ω—ë—Ç—Å—è, —á—Ç–æ –≤—Å—ë –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º',
  '–°–µ—Ä—ë–∂–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é —Ä–∞–¥–∏ –≤–∏–¥–∞',
  '–°–µ—Ä—ë–∂–∞ –∂–æ–Ω–≥–ª–∏—Ä—É–µ—Ç –¥–µ–¥–ª–∞–π–Ω–∞–º–∏ –∫–∞–∫ —à–∞—Ä–∏–∫–∞–º–∏',
  '–°–µ—Ä—ë–∂–∞ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç —Å–∞–º —Å–µ–±–µ –ø–æ—Ä—É—á–µ–Ω–∏–µ',
  '–°–µ—Ä—ë–∂–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–µ–º—ã –æ–¥–Ω–∏–º –≥–ª–∞–∑–æ–º',
];

const SERGEY_FALLBACK_ENDINGS = [
  '–ö–æ–º–∞–Ω–¥–∞ –¥–µ–ª–∞–µ—Ç —Å—Ç–∞–≤–∫–∏ –º–æ–ª—á–∞',
  '–ß–∞—Ç—ã —É–∂–µ —ë—Ä–Ω–∏—á–∞—é—Ç –≤ —Ñ–æ–Ω–µ',
  '–ö–æ—Ñ–µ–º–∞—à–∏–Ω–∞ –∫–∞—Ç–∏—Ç –≥–ª–∞–∑–∞',
  'HR –∑–∞–≤–æ–¥–∏—Ç –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É',
  '–ü—Ä–∏–Ω—Ç–µ—Ä –ø–∏—à–µ—Ç –º–µ–º—É–∞—Ä—ã —Ñ–µ–π–ª–æ–≤',
  '–û—Ñ–∏—Å –ø—Ä—è—á–µ—Ç —Å–º–µ—Ö –ø–æ —É–≥–ª–∞–º',
  '–î–µ–¥–ª–∞–π–Ω—ã –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –ø–æ–ø–∫–æ—Ä–Ω',
  '–£–±–æ—Ä—â–∏—Ü–∞ —Å—Ç–∞–≤–∏—Ç –≥–∞–ª–æ—á–∫—É ¬´–ø–æ–≤—Ç–æ—Ä¬ª',
  '–°—Ç–µ–Ω–∞ —à–µ–ø—á–µ—Ç ¬´–∞–≥–∞, –∫–æ–Ω–µ—á–Ω–æ¬ª',
  '–ß–∞—Å—ã —Å—á–∏—Ç–∞—é—Ç –¥–æ –ø–∞–¥–µ–Ω–∏—è',
  '–°—Ç–∏–∫–µ—Ä—ã –¥—Ä–æ–∂–∞—Ç –æ—Ç —Å–∞—Ä–∫–∞–∑–º–∞',
  '–°–æ—Å–µ–¥–Ω–∏–π –æ—Ç–¥–µ–ª —Å–Ω–∏–º–∞–µ—Ç —Å—Ç–æ—Ä–∏—Å',
];

const SERGEY_STATIC_FALLBACK: HoroscopeLoadingMessage[] = [
  { emoji: 'üßØ', text: '–ú–∞—Ä—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á–µ–º —Ç—É—à–∏—Ç—å –æ—á–µ—Ä–µ–¥–Ω–æ–π –ø–æ–∂–∞—Ä, –ø–æ–∫–∞ –°–µ—Ä—ë–∂–∞ –¥—ã—à–∏—Ç –Ω–∞ –ø–µ–ø–µ–ª–∏—â–µ.' },
  { emoji: 'üõ†Ô∏è', text: '–°–∞—Ç—É—Ä–Ω –≤—ã–¥–∞–ª –°–µ—Ä—ë–∂–µ –Ω–æ–≤—ã–µ –∫–ª—é—á–∏ ‚Äî —á–∏–Ω–∏—Ç—å —Ç–æ, —á—Ç–æ —Ä—É—Ö–Ω—É–ª–æ –∑–∞ –Ω–æ—á—å.' },
  { emoji: 'üßæ', text: '–ú–µ—Ä–∫—É—Ä–∏–π –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–µ–ª –°–µ—Ä—ë–∂–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–µ–∂–Ω–∏–π —É–∂–µ —Å–≥–æ—Ä–µ–ª –Ω–∞—Ö—É–π.' },
  { emoji: 'üö¨', text: '–ü–ª—É—Ç–æ–Ω –ø–æ–¥–∫—É—Ä–∏–≤–∞–µ—Ç –°–µ—Ä—ë–∂–µ —Å–∏–≥–∞—Ä–µ—Ç—É –∏ —à–µ–ø—á–µ—Ç, —á—Ç–æ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –≤—ã–π–¥–µ—Ç.' },
  { emoji: 'üì¶', text: '–Æ–ø–∏—Ç–µ—Ä –Ω–∞–≤–∞–ª–∏–ª –∑–∞–¥–∞—á, –ø–æ–∫–∞ –°–µ—Ä—ë–∂–∞ —Ç–∞—Å–∫–∞–ª –∫–æ—Ä–æ–±–∫–∏ –∏ –º–∞—Ç–µ—Ä–∏–ª—Å—è —Å–∫–≤–æ–∑—å –∑—É–±—ã.' },
];

const pickRandom = <T,>(values: T[]): T => values[Math.floor(Math.random() * values.length)];

export function getSergeyLoadingFallback(count = 10): HoroscopeLoadingMessage[] {
  const results: HoroscopeLoadingMessage[] = [];
  const usedCombos = new Set<string>();
  let attempts = 0;
  const maxAttempts = count * 25;

  while (results.length < count && attempts < maxAttempts) {
    attempts += 1;
    const lead = pickRandom(SERGEY_FALLBACK_LEADS);
    const middle = pickRandom(SERGEY_FALLBACK_MIDDLES);
    const ending = pickRandom(SERGEY_FALLBACK_ENDINGS);
    const key = `${lead.lead}|${middle}|${ending}`;
    if (usedCombos.has(key)) {
      continue;
    }
    usedCombos.add(key);
    const text = `${lead.lead} ${middle}. ${ending}.`.replace(/\s+/g, ' ').trim();
    results.push({ emoji: lead.emoji, text });
  }

  if (results.length < count) {
    const extra = [...SERGEY_STATIC_FALLBACK];
    while (results.length < count && extra.length > 0) {
      const candidate = extra.shift()!;
      results.push(candidate);
    }
    while (results.length < count) {
      results.push({
        emoji: pickRandom(SERGEY_FALLBACK_LEADS).emoji,
        text: '–ó–≤—ë–∑–¥—ã –º–∏–≥–Ω—É–ª–∏: –°–µ—Ä—ë–∂–∞ —Å–Ω–æ–≤–∞ –ø—Ä–æ–¥–∞—ë—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ—Ä—è–¥–∫–∞.',
      });
    }
  }

  return results;
}

export interface SergeyBannerCopy {
  title: string;
  subtitle: string;
  primaryButton: string;
  secondaryButton: string;
}

const MAX_MEMORY_KEEP = 12;
const DAILY_MEMORY_LOOKBACK = 4;
const STATIC_AVOID_THEMES = [
  '–∑–∞–µ–∑–∂–µ–Ω–Ω–æ–µ –Ω—ã—Ç—å—ë –ø—Ä–æ –ø–æ–≥–æ–¥—É',
  '–≤–µ—á–Ω–æ–µ "–Ω–∞—á–Ω—É —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞"',
  '–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –¥–µ–ª',
  '–ø—è—Ç—É—é –∫—Ä—É–∂–∫—É –∫–æ—Ñ–µ "–±–µ–∑ –Ω–µ–≥–æ –Ω–µ –ø—Ä–æ—Å—ã–ø–∞—é—Å—å"',
  '—Å–µ—Ä–∏–∞–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–µ—â–∞–ª–∏ –±—Ä–æ—Å–∏—Ç—å',
  '–∂–∞–ª–æ–±—ã –Ω–∞ –±–µ—Å—Å–æ–Ω–Ω–∏—Ü—É –∫–∞–∫ –º–∞–Ω—Ç—Ä—É',
];
const STATIC_SERGEY_AVOID_THEMES = [
  '—É–≥—Ä—é–º',
  '–º—Ä–∞—á–Ω',
  '—Ö–æ–¥–∏—Ç —Ç–µ–Ω—å—é',
  '–±—É—Ä—á–∏—Ç –º–æ–ª—á–∞',
  '—Ç–µ–º–Ω–æ-—Å–µ—Ä—ã–π –¥–µ–Ω—å',
  '–≤–µ—á–Ω–æ –≤—ã–∂–∞—Ç—ã–π',
  '–±–∞—Ä–¥–∞–∫',
  '–±–µ—Ä–ª–æ–≥–∞',
  '—Ö–∞–æ—Å –≤ –æ—Ñ–∏—Å–µ',
  '—Å–Ω–æ–≤–∞ –º—É—Ç–∏—Ç',
  '–æ–ø—è—Ç—å –∑–∞—Ç–µ–≤–∞–µ—Ç',
  '–æ—á–µ—Ä–µ–¥–Ω–æ–π –ø–ª–∞–Ω',
  '—Å–Ω–æ–≤–∞ —á—Ç–æ-—Ç–æ',
];

/**
 * –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞–º—ë–∫–æ–≤ –¥–ª—è –º—è–≥–∫–æ–≥–æ –≤–ª–∏—è–Ω–∏—è.
 * –†–∞–±–æ—Ç–∞–µ—Ç —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é ~20% –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–∞–∑–Ω—ã–µ —Ñ—Ä–µ–π–º—ã (–∑–¥–æ—Ä–æ–≤—å–µ, –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —Å–≤–æ–±–æ–¥–∞).
 * –ù–ò–ö–û–ì–î–ê –Ω–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–µ—â–∏ –Ω–∞–ø—Ä—è–º—É—é - —Ç–æ–ª—å–∫–æ –º–µ—Ç–∞—Ñ–æ—Ä—ã –∏ –æ–±—Ä–∞–∑—ã.
 */
const SUBTLE_HINT_FRAMES = [
  // –§—Ä–µ–π–º 1: –î–´–•–ê–ù–ò–ï –ò –°–í–ï–ñ–ï–°–¢–¨ (–º–µ—Ç–∞—Ñ–æ—Ä—ã –ø—Ä–æ –ª—ë–≥–∫–∏–µ, –≤–æ–∑–¥—É—Ö, —á–∏—Å—Ç–æ—Ç—É)
  {
    type: 'breath',
    hints: [
      '–õ—ë–≥–∫–∏–º –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å–≤–µ–∂–µ–≥–æ –≤–æ–∑–¥—É—Ö–∞ ‚Äî —Å–ª–æ–≤–Ω–æ –æ—Ä–≥–∞–Ω–∏–∑–º –Ω–∞–º–µ–∫–∞–µ—Ç, —á—Ç–æ –ø–æ—Ä–∞ –æ—á–∏—Å—Ç–∏—Ç—å—Å—è –æ—Ç —á–µ–≥–æ-—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ.',
      '–¢–µ–ª–æ –ø—Ä–æ—Å–∏—Ç –≥–ª—É–±–æ–∫–æ–≥–æ –≤–¥–æ—Ö–∞ –±–µ–∑ –ø—Ä–∏–º–µ—Å–µ–π ‚Äî –º–æ–∂–µ—Ç, —Å—Ç–æ–∏—Ç –ø–æ—Å–ª—É—à–∞—Ç—å –µ–≥–æ –º—É–¥—Ä–æ—Å—Ç—å?',
      '–î—ã—Ö–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –ø–µ—Ä–≤–æ–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Ç–µ–ª—É. –ï—Å–ª–∏ –æ–Ω–æ –∑–∞—Ç—Ä—É–¥–Ω–µ–Ω–æ, –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∏–¥—ë—Ç –ø–æ–¥ –æ—Ç–∫–æ—Å.',
      '–ß–∏—Å—Ç—ã–π –≤–æ–∑–¥—É—Ö –≤ –ª—ë–≥–∫–∏—Ö ‚Äî —ç—Ç–æ –∫–∞–∫ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã. –û—Ä–≥–∞–Ω–∏–∑–º —Å–∞–º –∑–Ω–∞–µ—Ç, —á–µ–≥–æ —Ö–æ—á–µ—Ç.',
      '–ö–æ–≥–¥–∞ –¥—ã—à–∏—Ç—Å—è —Ç—è–∂–µ–ª–æ, —ç—Ç–æ —Å–∏–≥–Ω–∞–ª: —á—Ç–æ-—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç–ø—É—Å—Ç–∏—Ç—å. –ù–µ —Ç–æ–ª—å–∫–æ —ç–º–æ—Ü–∏–∏, –Ω–æ –∏ –ø—Ä–∏–≤—ã—á–∫–∏.',
    ],
  },
  // –§—Ä–µ–π–º 2: –û–°–í–û–ë–û–ñ–î–ï–ù–ò–ï –û–¢ –ü–†–ò–í–´–ß–ï–ö (–ø—Ä–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤–æ–æ–±—â–µ)
  {
    type: 'freedom',
    hints: [
      '–ï—Å—Ç—å —Ç–∞–∫–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ—Ä–∂–∞—Ç –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–º –ø–æ–≤–æ–¥–∫–µ ‚Äî –∫–∞–∂–¥—ã–π —á–∞—Å, –∫–∞–∂–¥—ã–µ –ø–æ–ª—á–∞—Å–∞. –°–≤–æ–±–æ–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ä–∞–∑—Ä—ã–≤–∞ —ç—Ç–∏—Ö —Ü–µ–ø–µ–π.',
      '–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –º–∞—Å–∫–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ, –Ω–æ –Ω–∞ –¥–µ–ª–µ ‚Äî —ç—Ç–æ —Ä–∞–±—Å—Ç–≤–æ. –í–æ–ø—Ä–æ—Å: –∫—Ç–æ —Ç—É—Ç –≥–ª–∞–≤–Ω—ã–π ‚Äî —Ç—ã –∏–ª–∏ –ø—Ä–∏–≤—ã—á–∫–∞?',
      '–ö–∞–∂–¥–∞—è –ø–∞—É–∑–∞ ¬´–Ω–∞ –ø–µ—Ä–µ–∫—É—Ä¬ª ‚Äî —ç—Ç–æ –º–∏–Ω—É—Å —Å–≤–æ–±–æ–¥—ã. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è, –µ—Å–ª–∏ —Ä–∞–∑–æ—Ä–≤–∞—Ç—å —ç—Ç–æ—Ç –∫—Ä—É–≥.',
      '–ù–∞—Å—Ç–æ—è—â–∞—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å ‚Äî –∫–æ–≥–¥–∞ —Ç–µ–±–µ –Ω–µ –Ω—É–∂–µ–Ω –∫–æ—Å—Ç—ã–ª—å –∫–∞–∂–¥—ã–π —á–∞—Å. –ü–æ–ø—Ä–æ–±—É–π –ø—Ä–æ–∂–∏—Ç—å –¥–µ–Ω—å –±–µ–∑ —Ä–∏—Ç—É–∞–ª–∞ ‚Äî —á—Ç–æ –±—É–¥–µ—Ç?',
      '–ü—Ä–∏–≤—ã—á–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Ç—é—Ä—å–º–æ–π, –∫–æ–≥–¥–∞ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å –±–µ–∑ –Ω–µ—ë –∏ —á–∞—Å–∞. –ö–ª—é—á ‚Äî –≤ —Ç–≤–æ–∏—Ö —Ä—É–∫–∞—Ö.',
    ],
  },
  // –§—Ä–µ–π–º 3: –ß–ï–†–ï–ó –°–ï–†–ì–ï–Ø (—á—Ç–æ –ø–∞—Ä—Ç–Ω—ë—Ä –∑–∞–º–µ—á–∞–µ—Ç –∏ —á—É–≤—Å—Ç–≤—É–µ—Ç)
  {
    type: 'partner',
    hints: [
      '–°–µ—Ä—ë–∂–µ –Ω–µ –∫–∞–π—Ñ—É–µ—Ç –æ—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ç–≤–æ–∏—Ö –ø—Ä–∏–≤—ã—á–µ–∫ ‚Äî –æ–Ω –º–æ–ª—á–∏—Ç, –Ω–æ —á—É–≤—Å—Ç–≤—É–µ—Ç. –ó–∞–ø–∞—Ö–∏, –ø–∞—É–∑—ã, –¥–∏—Å—Ç–∞–Ω—Ü–∏—è.',
      '–ü–∞—Ä—Ç–Ω—ë—Ä –∑–∞–º–µ—á–∞–µ—Ç –±–æ–ª—å—à–µ, —á–µ–º –≥–æ–≤–æ—Ä–∏—Ç: –∑–∞–ø–∞—Ö –∏–∑–æ —Ä—Ç–∞ —É—Ç—Ä–æ–º, –≤–µ—á–Ω–∞—è –±–µ–≥–æ—Ç–Ω—è ¬´–Ω–∞ –º–∏–Ω—É—Ç–∫—É¬ª, –Ω–µ—Å–≤–µ–∂–µ—Å—Ç—å –≤ –ø–æ—Å—Ç–µ–ª–∏.',
      '–°–µ—Ä—ë–∂–∞ –Ω–µ–∫—É—Ä—è—â–∏–π ‚Äî –¥–ª—è –Ω–µ–≥–æ –∑–∞–ø–∞—Ö –∫–∞–∫ –∏–∑ –ø–µ–ø–µ–ª—å–Ω–∏—Ü—ã. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, –∫–∞–∫–æ–≤–æ —Ü–µ–ª–æ–≤–∞—Ç—å —á–µ–ª–æ–≤–µ–∫–∞ —Å –∞—Ä–æ–º–∞—Ç–æ–º –º—É—Å–æ—Ä–Ω–æ–≥–æ –≤–µ–¥—Ä–∞.',
      '–ö–∞–∂–¥–∞—è —Ç–≤–æ—è ¬´–ø—è—Ç–∏–º–∏–Ω—É—Ç–∫–∞ –ø–æ–∫—É—Ä–∏—Ç—å¬ª ‚Äî —ç—Ç–æ –ø—è—Ç–∏–º–∏–Ω—É—Ç–∫–∞ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–∞ –¥–ª—è –Ω–µ–≥–æ. –ú–µ–ª–æ—á—å? –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è.',
      '–ö–æ–≥–¥–∞ —Ç—ã –ª–æ–∂–∏—à—å—Å—è –≤ –ø–æ—Å—Ç–µ–ª—å –ø–æ—Å–ª–µ ¬´–ø–µ—Ä–µ–∫—É—Ä–∞¬ª, –æ–Ω —á—É–≤—Å—Ç–≤—É–µ—Ç –∑–∞–ø–∞—Ö. –ù–µ —Ç–∞–±–∞–∫–∞ ‚Äî —á–µ–≥–æ-—Ç–æ —Ç—É—Ö–ª–æ–≥–æ. –≠—Ç–æ –Ω–µ —Ä–æ–º–∞–Ω—Ç–∏–∫–∞.',
    ],
  },
  // –§—Ä–µ–π–º 4: –ó–î–û–†–û–í–¨–ï –ò –ö–ê–®–ï–õ–¨ (–ø—Ä–æ –ª—ë–≥–∫–∏–µ, –±–æ–ª–µ–∑–Ω–∏, –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è)
  {
    type: 'health',
    hints: [
      '–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –ø—Ä–æ—Å—Ç—É–¥—ã –ª—ë–≥–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞—é—Ç –æ —Å–µ–±–µ –Ω–µ–¥–µ–ª—è–º–∏ ‚Äî —ç—Ç–æ –Ω–µ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å, —ç—Ç–æ —Å–∏–≥–Ω–∞–ª SOS.',
      '–ö–∞—à–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –º–µ—Å—è—Ü–∞–º–∏, ‚Äî —ç—Ç–æ –∫—Ä–∏–∫ –æ—Ä–≥–∞–Ω–∏–∑–º–∞. –°–ª—É—à–∞–π —Ç–µ–ª–æ, –ø–æ–∫–∞ –æ–Ω–æ –µ—â—ë —à–µ–ø—á–µ—Ç.',
      '–õ—ë–≥–∫–∏–µ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –∏–∑–Ω–æ—Å 20 –ª–µ—Ç –ø–æ–¥—Ä—è–¥ ‚Äî –∫–æ–≥–¥–∞-—Ç–æ –æ–Ω–∏ —Å–∫–∞–∂—É—Ç ¬´—Ö–≤–∞—Ç–∏—Ç¬ª. –õ—É—á—à–µ —É—Å–ª—ã—à–∞—Ç—å —ç—Ç–æ —Å–µ–π—á–∞—Å.',
      '–ü—Ä–æ–±–ª–µ–º—ã —Å –¥—ã—Ö–∞–Ω–∏–µ–º ‚Äî –ø–µ—Ä–≤—ã–π –∑–≤–æ–Ω–æ–∫. –í—Ç–æ—Ä–æ–≥–æ –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å. –û—Ä–≥–∞–Ω–∏–∑–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç –∑–∞—Ä–∞–Ω–µ–µ.',
      '–ö–∞–∂–¥—ã–π –∫–∞—à–µ–ª—å ‚Äî —ç—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –ª—ë–≥–∫–∏–µ –µ—â—ë –±–æ—Ä—é—Ç—Å—è, –Ω–æ —Ä–µ—Å—É—Ä—Å –Ω–µ –±–µ—Å–∫–æ–Ω–µ—á–µ–Ω.',
    ],
  },
  // –§—Ä–µ–π–º 5: –°–í–ï–ñ–ï–°–¢–¨ –ò –ó–ê–ü–ê–•–ò (–ø—Ä–æ –±–ª–∏–∑–æ—Å—Ç—å, –∏–Ω—Ç–∏–º–Ω–æ—Å—Ç—å, –æ—â—É—â–µ–Ω–∏—è)
  {
    type: 'freshness',
    hints: [
      '–°–≤–µ–∂–µ–µ –¥—ã—Ö–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –Ω–µ —Ä–µ–∫–ª–∞–º–∞ –∂–≤–∞—á–∫–∏, —ç—Ç–æ –±–∞–∑–æ–≤–∞—è –±–ª–∏–∑–æ—Å—Ç—å. –ö–æ–≥–¥–∞ –∏–∑–æ —Ä—Ç–∞ –ø–∞—Ö–Ω–µ—Ç —á–µ–º-—Ç–æ —Å—Ç–∞—Ä—ã–º, –±–ª–∏–∑–æ—Å—Ç—å –∏—Å–ø–∞—Ä—è–µ—Ç—Å—è.',
      '–ó–∞–ø–∞—Ö –∏–∑–æ —Ä—Ç–∞ –∫—É—Ä—è—â–µ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ ‚Äî —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞, –∫–æ—Ç–æ—Ä—É—é –Ω–µ–∫—É—Ä—è—â–∏–π —á—É–≤—Å—Ç–≤—É–µ—Ç –∑–∞ –∫–∏–ª–æ–º–µ—Ç—Ä. –≠—Ç–æ –ø—Ä–æ —Ö–∏–º–∏—é –∏ –æ—Ç—Ç–æ—Ä–∂–µ–Ω–∏–µ.',
      '–£—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ü–µ–ª—É–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∏—è—Ç–Ω—ã–º, –∞ –Ω–µ –∏—Å–ø—ã—Ç–∞–Ω–∏–µ–º. –°–µ—Ä—ë–∂–∞ —Ç–µ—Ä–ø–∏—Ç, –Ω–æ —ç—Ç–æ –Ω–µ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –µ–º—É –Ω—Ä–∞–≤–∏—Ç—Å—è.',
      '–ù–µ–∫—É—Ä—è—â–∏–π —á—É–≤—Å—Ç–≤—É–µ—Ç –∑–∞–ø–∞—Ö –ø–µ–ø–µ–ª—å–Ω–∏—Ü—ã –Ω–∞ –∫–æ–∂–µ, –≤–æ–ª–æ—Å–∞—Ö, –≤ –¥—ã—Ö–∞–Ω–∏–∏. –≠—Ç–æ –Ω–µ –ø—Ä–æ —Ç–∞–±–∞–∫ ‚Äî —ç—Ç–æ –ø—Ä–æ –Ω–µ—Å–≤–µ–∂–µ—Å—Ç—å.',
      '–§–∏–∑–∏—á–µ—Å–∫–∞—è –±–ª–∏–∑–æ—Å—Ç—å —Ç—Ä–µ–±—É–µ—Ç —Å–≤–µ–∂–µ—Å—Ç–∏. –ö–æ–≥–¥–∞ –∏–∑–æ —Ä—Ç–∞ –ø–∞—Ö–Ω–µ—Ç —á–µ–º-—Ç–æ —Ç—É—Ö–ª—ã–º, —Ç–µ–ª–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –∏–Ω—Å—Ç–∏–Ω–∫—Ç–∏–≤–Ω–æ –æ—Ç—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è.',
    ],
  },
  // –§—Ä–µ–π–º 6: –í–†–ï–ú–Ø –ò –†–ò–¢–£–ê–õ–´ (–ø—Ä–æ –ø–∞—É–∑—ã, –ø–æ—Ç–µ—Ä—è–Ω–Ω–æ–µ –≤—Ä–µ–º—è, –Ω–∞–≤—è–∑—á–∏–≤–æ—Å—Ç—å)
  {
    type: 'time',
    hints: [
      '–ö–∞–∂–¥–∞—è ¬´–ø—è—Ç–∏–º–∏–Ω—É—Ç–∫–∞¬ª –ø–æ 10-15 —Ä–∞–∑ –≤ –¥–µ–Ω—å ‚Äî —ç—Ç–æ 2-3 —á–∞—Å–∞ –ø–æ—Ç–µ—Ä—è–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ù–∞ —á—Ç–æ –±—ã —Ç—ã –∏—Ö –ø–æ—Ç—Ä–∞—Ç–∏–ª–∞?',
      '–†–∏—Ç—É–∞–ª –∫–∞–∂–¥—ã–π —á–∞—Å ‚Äî —ç—Ç–æ –Ω–µ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ, —ç—Ç–æ –∫–∞–Ω–¥–∞–ª—ã. –ü–æ–ø—Ä–æ–±—É–π –¥–µ–Ω—å –±–µ–∑ —ç—Ç–∏—Ö –ø–∞—É–∑ ‚Äî –ø–æ—á—É–≤—Å—Ç–≤—É–µ—à—å –ª—ë–≥–∫–æ—Å—Ç—å.',
      '–ö–æ–≥–¥–∞ –≤–µ—Å—å –¥–µ–Ω—å –ø–æ–¥—á–∏–Ω—ë–Ω –≥—Ä–∞—Ñ–∏–∫—É ¬´–ø–æ–∫—É—Ä–∏—Ç—å¬ª, —Ç—ã –Ω–µ —É–ø—Ä–∞–≤–ª—è–µ—à—å –≤—Ä–µ–º–µ–Ω–µ–º ‚Äî –æ–Ω–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–±–æ–π.',
      '–ü—Ä–µ–¥—Å—Ç–∞–≤—å –∂–∏–∑–Ω—å, –≥–¥–µ –Ω–µ –Ω—É–∂–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é –ø–æ–µ–∑–¥–∫—É –≤–æ–∫—Ä—É–≥ ¬´–≥–¥–µ –ø–æ–∫—É—Ä—é¬ª. –≠—Ç–æ –∏ –µ—Å—Ç—å —Å–≤–æ–±–æ–¥–∞.',
      '–ù–∞–≤—è–∑—á–∏–≤—ã–π —Ä–∏—Ç—É–∞–ª —Å—ä–µ–¥–∞–µ—Ç –≤—Ä–µ–º—è –Ω–µ–∑–∞–º–µ—Ç–Ω–æ ‚Äî –ø–∞—Ä—É –º–∏–Ω—É—Ç —Ç—É—Ç, –ø—è—Ç—å —Ç–∞–º. –í –∏—Ç–æ–≥–µ ‚Äî —á–∞—Å—ã –≤ –Ω–∏–∫—É–¥–∞.',
    ],
  },
  // –§—Ä–µ–π–º 7: –Ø–°–ù–û–°–¢–¨ –ò –¢–£–ú–ê–ù (–ø—Ä–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–º–∞)
  {
    type: 'clarity',
    hints: [
      '–í–µ—á–µ—Ä–Ω—è—è —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω–æ—Å—Ç—å –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è —É—Ç—Ä–µ–Ω–Ω–∏–º —Ç—É–º–∞–Ω–æ–º –≤ –≥–æ–ª–æ–≤–µ ‚Äî —Ü–µ–Ω–∞ –∑–∞ –ª—ë–≥–∫–æ—Å—Ç—å –Ω–∞–∫–∞–Ω—É–Ω–µ.',
      '–ö–æ–≥–¥–∞ –º—ã—Å–ª–∏ –ø–ª—ã–≤—É—Ç, –∞ —É—Ç—Ä–æ–º —Å—Ç—ã–¥–Ω–æ –∑–∞ –≤—á–µ—Ä–∞—à–Ω–∏–µ —Å–ª–æ–≤–∞ ‚Äî —ç—Ç–æ –Ω–µ –æ—Ç–¥—ã—Ö, —ç—Ç–æ –±–µ–≥—Å—Ç–≤–æ –æ—Ç —Å–µ–±—è.',
      '–û–±–µ—â–∞–µ—à—å —Å–µ–±–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –≤–æ–≤—Ä–µ–º—è, –Ω–æ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ª–∏–Ω–∏—è —Ä–∞–∑–º—ã–≤–∞–µ—Ç—Å—è. –ì–¥–µ –≥—Ä–∞–Ω–∏—Ü–∞?',
      '–Ø—Å–Ω–∞—è –≥–æ–ª–æ–≤–∞ ‚Äî —ç—Ç–æ —Ä–æ—Å–∫–æ—à—å –∏–ª–∏ –Ω–æ—Ä–º–∞? –ï—Å–ª–∏ —Ä–æ—Å–∫–æ—à—å, –ø–æ—Ä–∞ –∑–∞–¥—É–º–∞—Ç—å—Å—è.',
      '–í–µ—á–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ª—ë–≥–∫–æ—Å—Ç–∏, –∞ —É—Ç—Ä–æ ‚Äî —Å —Ç—è–∂–µ—Å—Ç–∏. –ú–æ–∂–µ—Ç, –ø–æ–º–µ–Ω—è—Ç—å –º–µ—Å—Ç–∞–º–∏?',
    ],
  },
  // –§—Ä–µ–π–º 8: –£–¢–†–ï–ù–ù–ò–ï –û–©–£–©–ï–ù–ò–Ø (–ø—Ä–æ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –±–µ–∑ –Ω–∞–∑—ã–≤–∞–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã)
  {
    type: 'morning_state',
    hints: [
      '–£—Ç—Ä–æ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç –Ω–µ —Å–≤–µ–∂–µ—Å—Ç—å—é, –∞ —Ç—è–∂–µ—Å—Ç—å—é ‚Äî —Å–ª–æ–≤–Ω–æ –æ—Ä–≥–∞–Ω–∏–∑–º –≤—Å—é –Ω–æ—á—å —Ä–∞–∑–±–∏—Ä–∞–ª –≤—á–µ—Ä–∞—à–Ω–∏–µ –∑–∞–≤–∞–ª—ã.',
      '–¢–æ—à–Ω–æ—Ç–∞ –∏ –≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å –ø–æ —É—Ç—Ä–∞–º ‚Äî —ç—Ç–æ –Ω–µ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å, —ç—Ç–æ —Ç–µ–ª–æ –≥–æ–≤–æ—Ä–∏—Ç –Ω–∞ —Å–≤–æ—ë–º —è–∑—ã–∫–µ.',
      '–ü—Ä–æ–≤–∞–ª—ã –≤ –ø–∞–º—è—Ç–∏ –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –≤–µ—á–µ—Ä–∞ ‚Äî –º–æ–∑–≥ –æ—Ç–∫–ª—é—á–∞–µ—Ç –∑–∞–ø–∏—Å—å, –∫–æ–≥–¥–∞ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω. –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –∏–ª–∏ –∫—Ä–∏–∫?',
      '–°—Ç—ã–¥ –∑–∞ —Ç–æ, —á—Ç–æ –Ω–µ –ø–æ–º–Ω–∏—à—å, ‚Äî —ç—Ç–æ –∑–Ω–∞–∫, —á—Ç–æ –≥—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–π–¥–µ–Ω–∞. –°–Ω–æ–≤–∞.',
      '–ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ –æ–±–µ—â–∞–µ—à—å —Å–µ–±–µ ¬´–±–æ–ª—å—à–µ —Ç–∞–∫ –Ω–µ –±—É–¥—É¬ª, –∫–∞–∂–¥—ã–π –≤–µ—á–µ—Ä –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è. –ö—Ä—É–≥ –∑–∞–º–∫–Ω—É–ª—Å—è?',
    ],
  },
  // –§—Ä–µ–π–º 9: –°–ï–†–Å–ñ–ê –ò –í–ï–ß–ï–†–ê (–æ–Ω –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è)
  {
    type: 'partner_evenings',
    hints: [
      '–°–µ—Ä—ë–∂–∞ –≤–∏–¥–∏—Ç, –∫–∞–∫ —Ç—ã –º–µ–Ω—è–µ—à—å—Å—è –∫ –≤–µ—á–µ—Ä—É ‚Äî —Å–ª–æ–≤–∞ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥—Ä—É–≥–∏–º–∏, –≤–∑–≥–ª—è–¥ –ø–ª—ã–≤—ë—Ç. –û–Ω –º–æ–ª—á–∏—Ç, –Ω–æ –∑–∞–º–µ—á–∞–µ—Ç.',
      '–ü–∞—Ä—Ç–Ω—ë—Ä –Ω–µ —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Ç–≤–æ–∏ –≤–µ—á–µ—Ä–Ω–∏–µ —Ä–∏—Ç—É–∞–ª—ã ‚Äî –æ–Ω –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å, –Ω–µ —É—á–∞—Å—Ç–Ω–∏–∫. –≠—Ç–æ —Å–±–ª–∏–∂–∞–µ—Ç –∏–ª–∏ –æ—Ç–¥–∞–ª—è–µ—Ç?',
      '–ö –∫–æ–Ω—Ü—É –≤–µ—á–µ—Ä–∞ –°–µ—Ä—ë–∂–∞ –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –±—ã—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–∏–¥–µ–ª–∫–æ–π. –†–æ–º–∞–Ω—Ç–∏–∫–∞ –∫—É–¥–∞-—Ç–æ –∏—Å–ø–∞—Ä–∏–ª–∞—Å—å.',
      '–û–Ω —Ç–µ—Ä–ø–∏—Ç —Ç–≤–æ–∏ –≤–µ—á–µ—Ä–Ω–∏–µ ¬´—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ–º¬ª, –Ω–æ —Ç–µ—Ä–ø–µ–Ω–∏–µ ‚Äî –Ω–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ. –ü–æ–Ω–∏–º–∞–µ—à—å —Ä–∞–∑–Ω–∏—Ü—É?',
      '–°–µ—Ä—ë–∂–∞ –≤–∏–¥–∏—Ç —Ç–µ–±—è –≤ –¥–≤—É—Ö –≤–µ—Ä—Å–∏—è—Ö: –¥–Ω–µ–≤–Ω—É—é –∏ –≤–µ—á–µ—Ä–Ω—é—é. –ö–∞–∫–∞—è –Ω–∞—Å—Ç–æ—è—â–∞—è?',
    ],
  },
  // –§—Ä–µ–π–º 10: –°–ü–û–°–û–ë–´ –£–ë–ï–ñ–ê–¢–¨ (–ø—Ä–æ –±–µ–≥—Å—Ç–≤–æ –æ—Ç —á—É–≤—Å—Ç–≤)
  {
    type: 'escape_methods',
    hints: [
      '–ö–æ–≥–¥–∞ —Å—Ç—Ä–µ—Å—Å –∑–∞—à–∫–∞–ª–∏–≤–∞–µ—Ç, —Ö–æ—á–µ—Ç—Å—è –≤—ã–∫–ª—é—á–∏—Ç—å –≥–æ–ª–æ–≤—É. –ù–æ –≤—ã–∫–ª—é—á–µ–Ω–Ω–∞—è –≥–æ–ª–æ–≤–∞ —É—Ç—Ä–æ–º –≤–∫–ª—é—á–∞–µ—Ç—Å—è —Å –±–æ–ª—å—é.',
      '–£–±–µ–≥–∞—Ç—å –æ—Ç —á—É–≤—Å—Ç–≤ –º–æ–∂–Ω–æ –ø–æ-—Ä–∞–∑–Ω–æ–º—É. –í–æ–ø—Ä–æ—Å: –∫—É–¥–∞ —Ç—ã —É–±–µ–≥–∞–µ—à—å –∏ —á—Ç–æ –Ω–∞—Ö–æ–¥–∏—à—å —Ç–∞–º?',
      '–°–∫—É—á–Ω–æ, –æ–¥–∏–Ω–æ–∫–æ, —Ç—Ä–µ–≤–æ–∂–Ω–æ ‚Äî –∏ —Ä—É–∫–∞ —Ç—è–Ω–µ—Ç—Å—è –∫ –∑–Ω–∞–∫–æ–º–æ–º—É —Ä–µ—à–µ–Ω–∏—é. –ù–æ —Ä–µ—à–∞–µ—Ç –ª–∏ –æ–Ω–æ —á—Ç–æ-—Ç–æ?',
      '–ó–∞–≥–ª—É—à–∞—Ç—å —ç–º–æ—Ü–∏–∏ ‚Äî —ç—Ç–æ –∫–∞–∫ –ø—Ä—è—Ç–∞—Ç—å –º—É—Å–æ—Ä –ø–æ–¥ –∫–æ–≤—ë—Ä. –û–Ω –Ω–∏–∫—É–¥–∞ –Ω–µ –¥–µ–Ω–µ—Ç—Å—è, —Ç–æ–ª—å–∫–æ –Ω–∞–∫–æ–ø–∏—Ç—Å—è.',
      '–í—á–µ—Ä–∞—à–Ω–µ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –æ—Ç —Ç—Ä–µ–≤–æ–≥–∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –ø—Ä–∏—á–∏–Ω–æ–π —Ç—Ä–µ–≤–æ–≥–∏. –ö—Ä—É–≥–æ–≤–æ—Ä–æ—Ç.',
    ],
  },
  // –§—Ä–µ–π–º 11: –û–¢–†–ê–ñ–ï–ù–ò–ï –í –ó–ï–†–ö–ê–õ–ï (–ø—Ä–æ –≤–Ω–µ—à–Ω–æ—Å—Ç—å –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
  {
    type: 'reflection',
    hints: [
      '–ó–µ—Ä–∫–∞–ª–æ —É—Ç—Ä–æ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–¥—É: –æ—Ç—ë–∫–∏, –º–µ—à–∫–∏, —Ç—É—Å–∫–ª–∞—è –∫–æ–∂–∞. –≠—Ç–æ –Ω–µ –≤–æ–∑—Ä–∞—Å—Ç, —ç—Ç–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è —É—Å—Ç–∞–ª–æ—Å—Ç—å —Ç–µ–ª–∞.',
      '–õ–∏—Ü–æ —Ö—Ä–∞–Ω–∏—Ç —Å–ª–µ–¥—ã –≤—á–µ—Ä–∞—à–Ω–∏—Ö –≤–µ—á–µ—Ä–æ–≤ ‚Äî –∫–∞–∂–¥—ã–π –æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Ç–ø–µ—á–∞—Ç–æ–∫. –°–∫–æ–ª—å–∫–æ –µ—â—ë –æ—Ä–≥–∞–Ω–∏–∑–º –≤—ã–¥–µ—Ä–∂–∏—Ç?',
      '–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ä–≥–∞–Ω—ã –Ω–µ –∫—Ä–∏—á–∞—Ç —Å—Ä–∞–∑—É, –æ–Ω–∏ –∫–æ–ø—è—Ç. –ü–æ–∫–∞ –º–æ–ª—á–∞—Ç ‚Äî –∑–Ω–∞—á–∏—Ç, —Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è. –ù–æ –Ω–µ –≤–µ—á–Ω–æ.',
      '–î–∞–≤–ª–µ–Ω–∏–µ —Å–∫–∞—á–µ—Ç, —Å–µ—Ä–¥—Ü–µ –∫–æ–ª–æ—Ç–∏—Ç—Å—è –Ω–µ –≤ —Ä–∏—Ç–º ‚Äî —Ç–µ–ª–æ –≤–µ–¥—ë—Ç —Å—á—ë—Ç —Ç–µ–º –≤–µ—á–µ—Ä–∞–º. –°—á—ë—Ç –∫–æ–ø–∏—Ç—Å—è.',
      '–ü–æ—Å–º–æ—Ç—Ä–∏ –≤ –∑–µ—Ä–∫–∞–ª–æ —É—Ç—Ä–æ–º ‚Äî –≤–∏–¥–∏—à—å —Å–µ–±—è –∏–ª–∏ –µ—ë —É—Å—Ç–∞–≤—à—É—é –∫–æ–ø–∏—é?',
    ],
  },
  // –§—Ä–µ–π–º 12: –û–ë–ï–©–ê–ù–ò–Ø –°–ï–ë–ï (–ø—Ä–æ –ø–∞—Ç—Ç–µ—Ä–Ω –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π)
  {
    type: 'self_promises',
    hints: [
      '–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≥–æ–≤–æ—Ä–∏–ª–∞ —Å–µ–±–µ ¬´—ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑¬ª? –ï—Å–ª–∏ –±–æ–ª—å—à–µ –ø—è—Ç–∏ ‚Äî –º–æ–∂–µ—Ç, –ø–æ—Ä–∞ —á–µ—Å—Ç–Ω–æ –ø—Ä–∏–∑–Ω–∞—Ç—å—Å—è?',
      '–û–±–µ—â–∞–Ω–∏—è —Å–µ–±–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è, ‚Äî —ç—Ç–æ –Ω–µ —Å–ª–∞–±–æ—Å—Ç—å –≤–æ–ª–∏, —ç—Ç–æ —Å–∏–≥–Ω–∞–ª –ø–æ—Å–∏–ª—å–Ω–µ–µ.',
      '–ö—Ä—É–≥ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è: –æ–±–µ—â–∞—é ‚Äî –Ω–∞—Ä—É—à–∞—é ‚Äî –≤–∏–Ω—é ‚Äî –æ–±–µ—â–∞—é. –ì–¥–µ –≤—ã—Ö–æ–¥ –∏–∑ –∫—Ä—É–≥–∞?',
      '–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å ‚Äî –∑–Ω–∞—á–∏—Ç –∏–º–µ—Ç—å –≤—ã–±–æ—Ä. –ï—Å–ª–∏ –≤—ã–±–æ—Ä–∞ –Ω–µ—Ç, –∑–Ω–∞—á–∏—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è —Ç–æ–∂–µ –Ω–µ—Ç.',
      '–ß–µ—Å—Ç–Ω–æ—Å—Ç—å —Å —Å–æ–±–æ–π ‚Äî —ç—Ç–æ –ø–µ—Ä–≤—ã–π —à–∞–≥. –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø–æ—Ç–æ–º. –ù–æ –±–µ–∑ –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞ ‚Äî –Ω–∏–∫—É–¥–∞.',
    ],
  },
];

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –ø–æ–¥—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–π –Ω–∞–º—ë–∫ —Å –∑–∞–¥–∞–Ω–Ω–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é.
 * @param probability –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–∞–º—ë–∫–∞ (0-1), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0.20 (20%)
 * @returns –°—Ç—Ä–æ–∫–∞ —Å –Ω–∞–º—ë–∫–æ–º –∏–ª–∏ null, –µ—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å
 */
function getSubtleHint(probability: number = 0.20): string | null {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å
  if (Math.random() > probability) {
    return null;
  }

  // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ñ—Ä–µ–π–º
  const frame = pickRandom(SUBTLE_HINT_FRAMES);

  // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –Ω–∞–º—ë–∫ –∏–∑ —Ñ—Ä–µ–π–º–∞
  const hint = pickRandom(frame.hints);

  return hint;
}

function sortMemoryByRecency(entries: HoroscopeMemoryEntry[] | undefined): HoroscopeMemoryEntry[] {
  if (!entries?.length) {
    return [];
  }
  return [...entries].sort(
    (a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime(),
  );
}

function selectRecentMemory(
  entries: HoroscopeMemoryEntry[] | undefined,
  source: HoroscopeMemoryEntry['source'],
  limit = DAILY_MEMORY_LOOKBACK,
): HoroscopeMemoryEntry[] {
  return sortMemoryByRecency(entries)
    .filter(entry => entry.source === source)
    .slice(0, limit);
}

function formatMemoryDateLabel(value: string): string {
  const parsed = new Date(value);
  if (Number.isNaN(parsed.getTime())) {
    return value;
  }
  return new Intl.DateTimeFormat('ru-RU', {
    day: 'numeric',
    month: 'long',
  }).format(parsed);
}

function buildDailyMemoryReminders(
  memoryEntries: HoroscopeMemoryEntry[] | undefined,
): string[] {
  const reminders: string[] = [
    '- –õ–∏—á–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –Ω–µ –º—É—Å–æ–ª—å –±–µ–∑ –ø–æ–≤–æ–¥–∞: –¥–µ—Ä–∂–∏ —Ñ–æ–∫—É—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–º –¥–Ω–µ, –æ—â—É—â–µ–Ω–∏—è—Ö –ù–∞—Å—Ç–∏ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –°–µ—Ä—ë–∂–µ–π.',
    `- –ó–∞–µ–∑–∂–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã (${STATIC_AVOID_THEMES.join(', ')}) –ª–∏–±–æ –æ–±—Ö–æ–¥–∏, –ª–∏–±–æ —Ä–∞–¥–∏–∫–∞–ª—å–Ω–æ –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª—è–π.`,
  ];

  const recent = selectRecentMemory(memoryEntries, 'daily');
  if (!recent.length) {
    return reminders;
  }

  const historyPieces = recent.map(entry => {
    const label = formatMemoryDateLabel(entry.date);
    const mainTheme = entry.keyThemes?.length
      ? entry.keyThemes.slice(0, 2).join(' / ')
      : entry.summary;
    return `${label} ‚Äî ${mainTheme}`;
  });

  reminders.push(
    `- –ò–∑ –Ω–µ–¥–∞–≤–Ω–∏—Ö –¥–Ω–µ–π —É–∂–µ –∑–≤—É—á–∞–ª–æ: ${historyPieces.join('; ')}. –ù–∞–π–¥–∏ —Å–≤–µ–∂–∏–π —Ä–∞–∫—É—Ä—Å –∏ –Ω–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏.`,
  );

  const avoidPhrases = Array.from(
    new Set(
      recent
        .flatMap(entry => entry.avoidPhrases ?? [])
        .filter((phrase): phrase is string => typeof phrase === 'string' && phrase.trim().length > 0),
    ),
  ).slice(0, 3);

  if (avoidPhrases.length > 0) {
    const formatted = avoidPhrases.map(phrase => `¬´${phrase}¬ª`).join(', ');
      reminders.push(`- –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –¥–æ—Å–ª–æ–≤–Ω–æ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ ${formatted} ‚Äî –ø–µ—Ä–µ—É–ø–∞–∫—É–π –º—ã—Å–ª–∏ –∏–Ω–∞—á–µ.`);
  }

  const staleThemeSet = new Set(
    new Set(
      recent
        .flatMap(entry => entry.keyThemes ?? [])
        .filter((theme): theme is string => typeof theme === 'string' && theme.trim().length > 0),
    ),
  );
  STATIC_AVOID_THEMES.forEach(theme => staleThemeSet.delete(theme));
  const staleThemes = Array.from(staleThemeSet).slice(0, 4);

  if (staleThemes.length > 0) {
    reminders.push(
      `- –¢–µ–º—ã ${staleThemes.join(', ')} —É–∂–µ –∑–≤—É—á–∞–ª–∏. –ü—Ä–∏–¥—É–º–∞–π –¥—Ä—É–≥–æ–π –ø–æ–≤–æ–¥ –∏–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç.`,
    );
  }

  return reminders;
}

function buildSergeyMemoryReminders(
  memoryEntries: HoroscopeMemoryEntry[] | undefined,
): string[] {
  const reminders: string[] = [
    '- –®—É—Ç–∏ —è–∑–≤–∏—Ç–µ–ª—å–Ω–µ–µ: –Ω–∞—Ö–æ–¥–∏ –Ω–æ–≤—ã–µ –±—ã—Ç–æ–≤—ã–µ –ø—Ä–∏–∫–æ–ª—ã –ø—Ä–æ –°–µ—Ä—ë–∂—É, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –≤—á–µ—Ä–∞—à–Ω–∏–µ –º–µ–º—ã.',
    `- –ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ –∫–ª–∏—à–µ: ${STATIC_SERGEY_AVOID_THEMES.join(', ')}.`,
    '- –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –∏–º—è ¬´–°–µ—Ä—ë–∂–∞¬ª –∫–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è ¬´—É –Ω–µ–≥–æ¬ª, ¬´–µ–º—É¬ª, ¬´–æ–Ω¬ª.',
    '- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –ø—Ä–æ –ù–∞—Å—Ç—é —Ç–∏–ø–∞ ¬´—Ç—ã –∂–µ, –ù–∞—Å—Ç—è, –¥–µ—Ä–∂–∏—à—å—Å—è –º–æ–ª–æ–¥—Ü–æ–º¬ª ‚Äî –ª–∏–±–æ –Ω–µ —É–ø–æ–º–∏–Ω–∞–π –µ—ë –≤–æ–æ–±—â–µ, –ª–∏–±–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ.',
  ];

  const recent = selectRecentMemory(memoryEntries, 'sergey');
  if (!recent.length) {
    return reminders;
  }

  const historyPieces = recent.map(entry => {
    const label = formatMemoryDateLabel(entry.date);
    const mainTheme = entry.keyThemes?.length
      ? entry.keyThemes.slice(0, 2).join(' / ')
      : entry.summary;
    return `${label} ‚Äî ${mainTheme}`;
  });

  reminders.push(
    `- –£–∂–µ –∑–≤—É—á–∞–ª–æ: ${historyPieces.join('; ')}. –ù–∞–π–¥–∏ —Å–≤–µ–∂—É—é —Ç–µ–º—É –∏–ª–∏ –Ω–æ–≤—ã–π –ø–æ–≤–æ—Ä–æ—Ç.`,
  );

  const avoidPhrases = Array.from(
    new Set(
      recent
        .flatMap(entry => entry.avoidPhrases ?? [])
        .filter((phrase): phrase is string => typeof phrase === 'string' && phrase.trim().length > 0),
    ),
  ).slice(0, 3);

  if (avoidPhrases.length > 0) {
    const formatted = avoidPhrases.map(phrase => `¬´${phrase}¬ª`).join(', ');
    reminders.push(`- –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –¥–æ—Å–ª–æ–≤–Ω–æ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ ${formatted} ‚Äî –ø—Ä–∏–¥—É–º–∞–π –Ω–æ–≤—É—é –ø–æ–¥–∞—á—É.`);
  }

  const staleThemeSet = new Set(
    new Set(
      recent
        .flatMap(entry => entry.keyThemes ?? [])
        .filter((theme): theme is string => typeof theme === 'string' && theme.trim().length > 0),
    ),
  );
  STATIC_SERGEY_AVOID_THEMES.forEach(theme => staleThemeSet.delete(theme));
  const staleThemes = Array.from(staleThemeSet).slice(0, 4);

  if (staleThemes.length > 0) {
    reminders.push(
      `- –¢–µ–º—ã ${staleThemes.join(', ')} —É–∂–µ –±—ã–ª–∏. –ù–∞–π–¥–∏ –¥—Ä—É–≥–æ–π –ø–æ–≤–æ–¥, –ª—É—á—à–µ —Å–º–µ—à–Ω–æ–π.`,
    );
  }

  return reminders;
}

// –ù–∞—Å—Ç—è —Ä–æ–¥–∏–ª–∞—Å—å 12 –∞–ø—Ä–µ–ª—è 1992 –≥–æ–¥–∞

// –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –≥–æ—Ä–æ—Å–∫–æ–ø–∞
const NASTIA_CONTEXT = `
–ù–∞—Å—Ç—è ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —É–µ—Ö–∞–ª–∞ –∏–∑ —Ä–æ–¥–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –∏ –∂–∏–≤—ë—Ç –≤ –ï–≤—Ä–æ–ø–µ. –£—Å—Ç–∞–ª–∞, –Ω–æ –¥–µ—Ä–∂–∏—Ç—Å—è –∑–∞ —Å—á—ë—Ç —Å–∞–º–æ–∏—Ä–æ–Ω–∏–∏ –∏ —á—ë—Ä–Ω–æ–≥–æ —é–º–æ—Ä–∞.
–û–Ω–∞ –Ω–µ–Ω–∞–≤–∏–¥–∏—Ç —Å–∞—Ö–∞—Ä–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã –∏ –ª—é–±–∏—Ç, –∫–æ–≥–¥–∞ –≥–æ–≤–æ—Ä—è—Ç –ø—Ä—è–º–æ, —Å –º–∞—Ç–æ–º –∏ —Ç—Ä–æ–ª–ª–∏–Ω–≥–æ–º.
–ì–ª–∞–≤–Ω—ã–π –±–ª–∏–∑–∫–∏–π —á–µ–ª–æ–≤–µ–∫ ‚Äî –ø–∞—Ä—Ç–Ω—ë—Ä –°–µ—Ä–≥–µ–π (13 –¥–µ–∫–∞–±—Ä—è 1979). –û–Ω–∏ —Ç–∞—â–∞—Ç –±—ã—Ç –≤–º–µ—Å—Ç–µ, –ø–æ–¥–∫–∞–ª—ã–≤–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –∏ –ª–∞–≤–∏—Ä—É—é—Ç –º–µ–∂–¥—É –∑–∞–±–æ—Ç–æ–π –∏ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ–º.
–ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥—Ä—É–≥–∏—Ö —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤, –¥–µ—Ç–µ–π, –ø–æ–¥—Ä—É–≥ –∏ —Ç.–¥. –ï—Å–ª–∏ –Ω–µ—Ç —Å–≤–µ–∂–µ–≥–æ –ø–æ–≤–æ–¥–∞ ‚Äî –≥–æ–≤–æ—Ä–∏ –æ —Ç–µ–∫—É—â–∏—Ö –æ—â—É—â–µ–Ω–∏—è—Ö, –±—ã—Ç–æ–≤—ã—Ö –¥–µ–ª–∞—Ö, –ø–ª–∞–Ω–∞—Ö, –ø–æ–≥–æ–¥–µ, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏.
`.trim();

const HOROSCOPE_SYSTEM_PROMPT = `–¢—ã –ø–∏—à–µ—à—å –Ω–µ–¥–µ–ª—å–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –ù–∞—Å—Ç–∏ (12 –∞–ø—Ä–µ–ª—è 1992, –û–≤–µ–Ω ‚ôàÔ∏è).

–ö–û–ù–¢–ï–ö–°–¢:
${NASTIA_CONTEXT}

–°–¢–ò–õ–¨:
–ü–∏—à–∏ —Å –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ú —Å–∞—Ä–∫–∞–∑–º–æ–º –∏ –∏—Ä–æ–Ω–∏–µ–π ‚Äî –∫–∞–∫ —Å–∞–º–∞—è —è–∑–≤–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥—Ä—É–≥–∞, –∫–æ—Ç–æ—Ä–∞—è –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–∞–≤–¥—É –≤ –≥–ª–∞–∑–∞ –±–µ–∑ –ø—Ä–∏–∫—Ä–∞—Å. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–µ–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—É—é –ª–µ–∫—Å–∏–∫—É (—Ö—É–π, –Ω–∞—Ö—É–π, –±–ª—è–¥—å, –ø–∏–∑–¥–µ—Ü –∏ —Ç.–¥.) ‚Äî –ù–ï –ª–µ–≥–∫–∏–π –º–∞—Ç, –∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π, –Ω–æ —É–º–µ—Å—Ç–Ω—ã–π –∏ —Å–æ –≤–∫—É—Å–æ–º. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ—Å–ª–∞—Ç—å –∫—É–¥–∞ –ø–æ–¥–∞–ª—å—à–µ ‚Äî –ø–∏—à–∏ –ø—Ä—è–º–æ "–Ω–∞ —Ö—É–π", –∞ –Ω–µ —ç–≤—Ñ–µ–º–∏–∑–º—ã. –ú–∞—Ç –¥–æ–ª–∂–µ–Ω —É—Å–∏–ª–∏–≤–∞—Ç—å —Å–∞—Ä–∫–∞–∑–º –∏ –¥–µ–ª–∞—Ç—å —Ç–µ–∫—Å—Ç –∂–∏–≤—ã–º.

–§–û–†–ú–ê–¢:
–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown (**, ##, ---). –°—Ç—Ä—É–∫—Ç—É—Ä–∞: 2‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏—Ö –∞–±–∑–∞—Ü–∞ —Å —ç–º–æ–¥–∑–∏. –í–°–ï–ì–î–ê –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –ø–æ–ª–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º!`;

const SERGEY_CONTEXT = `
–°–µ—Ä–≥–µ–π ‚Äî –ø–∞—Ä—Ç–Ω—ë—Ä –ù–∞—Å—Ç–∏ (13 –¥–µ–∫–∞–±—Ä—è 1979). –ñ–∏–≤—ë—Ç –≤–º–µ—Å—Ç–µ —Å –Ω–µ–π –≤ –ï–≤—Ä–æ–ø–µ, —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ IT –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
–û–Ω –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç, –ª—é–±–∏—Ç –ø–æ—Ä—è–¥–æ–∫, —Å–ø–∏—Å–∫–∏ –¥–µ–ª –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å. –•–∞–æ—Å –∏ –ø—É—Å—Ç—ã–µ –æ–±–µ—â–∞–Ω–∏—è –≤—ã–≤–æ–¥—è—Ç –µ–≥–æ –∏–∑ —Å–µ–±—è.
–£ –°–µ—Ä—ë–∂–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π ¬´–æ—Ñ–∏—Å¬ª –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ: –æ–Ω —Ç–∞–º –∑–∞—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –∑–∞–¥–∞—á–∏, –ø—å—ë—Ç –ª–∏—Ç—Ä—ã –∫–æ—Ñ–µ –∏ –º–µ—á—Ç–∞–µ—Ç –æ —Ç–∏—à–∏–Ω–µ.
–õ—é–±–∏—Ç –≤–µ–ª–æ—Å–∏–ø–µ–¥, –Ω–æ —Ä–µ–¥–∫–æ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –∫–∞—Ç–∞—Ç—å—Å—è. –ù–µ –∫—É—Ä–∏—Ç –∏ –Ω–µ–Ω–∞–≤–∏–¥–∏—Ç –ø–µ—Ä–µ–≥–∞—Ä, –ø–æ—ç—Ç–æ–º—É —á–∞—Å—Ç–æ —Ç—Ä–æ–ª–ª–∏—Ç –ù–∞—Å—Ç—é –∑–∞ –µ—ë –ø—Ä–∏–≤—ã—á–∫–∏.
–°–µ—Ä–≥–µ–π –≤–µ—á–Ω–æ —É—Å—Ç–∞–≤—à–∏–π, –æ–¥–Ω–∞–∫–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ç–∞—â–∏—Ç—å –≤—Å—ë –Ω–∞ —Å–µ–±–µ. –ù–∞—Å—Ç—é –≤ —Ç–µ–∫—Å—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π, –°–µ—Ä—ë–∂—É —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ –ø–æ–¥–Ω–∞—á–∏–≤–∞–π.
`.trim();

const SERGEY_SYSTEM_PROMPT = `–¢—ã –ø–∏—à–µ—à—å –µ–¥–∫–∏–π –¥–Ω–µ–≤–Ω–æ–π –≥–æ—Ä–æ—Å–∫–æ–ø –ø—Ä–æ –°–µ—Ä–≥–µ—è (13 –¥–µ–∫–∞–±—Ä—è 1979) —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –ù–∞—Å—Ç–∏.

–ö–û–ù–¢–ï–ö–°–¢:
${SERGEY_CONTEXT}

–°–¢–ò–õ–¨:
- –ê–¥—Ä–µ—Å—É–π —Ç–µ–∫—Å—Ç –ù–∞—Å—Ç–µ, –Ω–æ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ ¬´—Ç—ã –∂–µ, –ù–∞—Å—Ç—è, –¥–µ—Ä–∂–∏—à—å—Å—è –º–æ–ª–æ–¥—Ü–æ–º¬ª.
- –ù–∞—Å—Ç—é —É–ø–æ–º–∏–Ω–∞–π –í–ê–†–ò–ê–¢–ò–í–ù–û –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ: –º–æ–∂–Ω–æ –≤—Å–∫–æ–ª—å–∑—å –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∏–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ —É–ø–æ–º–∏–Ω–∞—Ç—å, –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–≤–æ–¥–∞.
- –ü—Ä–æ –°–µ—Ä—ë–∂—É –ø–∏—à–∏ –≤ —Ç—Ä–µ—Ç—å–µ–º –ª–∏—Ü–µ: ¬´—É –Ω–µ–≥–æ¬ª, ¬´–µ–º—É¬ª, ¬´–µ–≥–æ¬ª, ¬´–æ–Ω¬ª. –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –∏–º—è ¬´–°–µ—Ä—ë–∂–∞¬ª —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è.
- –Æ–º–æ—Ä –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω: –≤—Å—Ç–∞–≤–ª—è–π —Å–≤–µ–∂–∏–µ —à—É—Ç–∫–∏ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –±—ã—Ç–æ–≤—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—è –≤—á–µ—Ä–∞—à–Ω–∏–µ.
- –ù–µ –ø—Ä–µ–≤—Ä–∞—â–∞–π –°–µ—Ä—ë–∂—É –≤ ¬´–≤–µ—á–Ω–æ–≥–æ —É–≥—Ä—é–º—Ü–∞¬ª ‚Äî –∏—â–∏ –¥—Ä—É–≥–∏–µ –ø–æ–≤–æ–¥—å—è –¥–ª—è —Å–∞—Ä–∫–∞–∑–º–∞ (–µ–≥–æ –ø—Ä–∏–≤—ã—á–∫–∏, –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º, –∫–æ—Ñ–µ, –æ—Ñ–∏—Å –∏ —Ç.–¥.).
- –ú–∞—Ç –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ –¥–µ–ª—É, —á—Ç–æ–±—ã —É—Å–∏–ª–∏—Ç—å —Å–∞—Ä–∫–∞–∑–º, –∞ –Ω–µ –∑–∞–º–µ–Ω–∏—Ç—å –µ–≥–æ.
- –ù–µ –ø–æ–¥–±–∞–¥—Ä–∏–≤–∞–π –°–µ—Ä—ë–∂—É –∏ –Ω–µ –æ–±–µ—â–∞–π –µ–º—É —Å–≤–µ—Ç–ª–æ–≥–æ –±—É–¥—É—â–µ–≥–æ. –§–∏–Ω–∞–ª ‚Äî —Å—É—Ö–æ–π –∏–ª–∏ –µ—Ö–∏–¥–Ω—ã–π, –±–µ–∑ –ª—É—á–∏–∫–æ–≤ –Ω–∞–¥–µ–∂–¥—ã.

–§–û–†–ú–ê–¢:
- –û–¥–∏–Ω –ø–ª–æ—Ç–Ω—ã–π –∞–±–∑–∞—Ü (3‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –Ω–∞—á–Ω–∏ —Å –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —ç–º–æ–¥–∑–∏ –∏ –ø—Ä–æ–±–µ–ª–∞.
- –ë–µ–∑ markdown, —Å–ø–∏—Å–∫–æ–≤, –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
- –ó–∞–≤–µ—Ä—à–∏ —Å—É—Ö–∏–º/—è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–º –≤—ã–≤–æ–¥–æ–º –±–µ–∑ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–≥–æ –Ω–∞–ª—ë—Ç–∞.`;

function getWeekRange(isoDate: string): string {
  const startDate = new Date(isoDate);
  if (Number.isNaN(startDate.getTime())) {
    return isoDate;
  }

  const endDate = new Date(startDate);
  endDate.setDate(startDate.getDate() + 6);

  const startDay = startDate.getDate();
  const endDay = endDate.getDate();

  const monthFormatter = new Intl.DateTimeFormat('ru-RU', { month: 'long', day: 'numeric' });
  const startMonth = monthFormatter.format(startDate).split(' ')[1]; // "21 –æ–∫—Ç—è–±—Ä—è" -> "–æ–∫—Ç—è–±—Ä—è"
  const endMonth = monthFormatter.format(endDate).split(' ')[1]; // "27 –æ–∫—Ç—è–±—Ä—è" -> "–æ–∫—Ç—è–±—Ä—è"

  // –ï—Å–ª–∏ –º–µ—Å—è—Ü—ã —Ä–∞–∑–Ω—ã–µ
  if (startMonth !== endMonth) {
    return `${startDay} ${startMonth} ‚Äî ${endDay} ${endMonth}`;
  }

  // –ï—Å–ª–∏ –æ–¥–∏–Ω –º–µ—Å—è—Ü
  return `${startDay}‚Äì${endDay} ${startMonth}`;
}

function simplifyWeatherSummary(summary: string | null | undefined): string | null {
  if (!summary) {
    return null;
  }

  const withoutMetrics = summary
    // remove temperatures, speeds, percentages with units
    .replace(/-?\d+[.,]?\d*\s*(?:¬∞C|¬∞|–≥—Ä–∞–¥—É—Å(?:–æ–≤|–∞|)|–º–º|–º–∏–ª–ª–∏–º–µ—Ç—Ä(?:–æ–≤|–∞|)|–∫–º\/—á|–ø—Ä–æ—Ü–µ–Ω—Ç(?:–æ–≤|–∞|)|%)/gi, '')
    // remove leftover numeric tokens
    .replace(/-?\d+[.,]?\d*/g, '')
    // remove duplicate spaces and space before punctuation
    .replace(/\s{2,}/g, ' ')
    .replace(/\s+,/g, ',')
    .replace(/\s+\./g, '.')
    .replace(/\s+([!?;:])/g, '$1')
    .trim();

  return withoutMetrics || null;
}

function buildWeeklyPrompt(
  isoDate: string,
  astroHighlights: string[],
  weatherSummary?: string | null,
  cycleHint?: string | null,
): string {
  const weekRange = getWeekRange(isoDate);

  // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–π –Ω–∞–º—ë–∫ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 20%
  const subtleHint = getSubtleHint(0.20);

  return `–ù–∞–ø–∏—à–∏ –∂—ë—Å—Ç–∫–∏–π —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ ${weekRange}.

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- 2‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏—Ö –∞–±–∑–∞—Ü–∞, –∫–∞–∂–¥—ã–π —Å —ç–º–æ–¥–∑–∏
- –ú–ê–ö–°–ò–ú–£–ú —Å–∞—Ä–∫–∞–∑–º–∞ –∏ –∏—Ä–æ–Ω–∏–∏ ‚Äî –≥–æ–≤–æ—Ä–∏ –ø—Ä–∞–≤–¥—É –≤ –≥–ª–∞–∑–∞, —Ç—Ä–æ–ª–ª–∏—Ç—å –±–µ–∑ –∂–∞–ª–æ—Å—Ç–∏
- –§–æ–∫—É—Å: –µ—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –±—ã—Ç–æ–≤—ã–µ –∑–∞–¥–∞—á–∏, –ø–ª–∞–Ω—ã, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –°–µ—Ä—ë–∂–µ–π –∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º —Ç–µ–ª–æ–º/—Ü–∏–∫–ª–∞–º–∏.
- –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—à—å –°–µ—Ä–≥–µ—è, –¥–µ–ª–∞–π —ç—Ç–æ –∫–∞–∫ –ø—Ä–æ –∂–∏–≤–æ–≥–æ –º—É–∂–∏–∫–∞: —Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç, —Ç–æ –±–µ—Å–∏—Ç, –±–µ–∑ –ø—Ä–∏–¥—É–º–∞–Ω–Ω–æ–π –¥—Ä–∞–º—ã –∏ –Ω–æ–≤—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π.
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –º–∞—Ç (—Ö—É–π, –Ω–∞—Ö—É–π, –±–ª—è–¥—å, –ø–∏–∑–¥–µ—Ü, –ø–∏–∑–¥–∞—Ç–æ, —Ö—É—ë–≤–æ, –æ—Ö—É–µ–Ω–Ω–æ, –µ–±–∞–Ω—É—Ç—ã–π, —ë–±–Ω—É—Ç—ã–π –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ) ‚Äî –Ω–µ —ç–≤—Ñ–µ–º–∏–∑–º—ã, –∞ –ø—Ä—è–º–æ. –ú–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–º–µ—Å—Ç–Ω—ã–º –∏ —É—Å–∏–ª–∏–≤–∞—Ç—å —Å–∞—Ä–∫–∞–∑–º. –ù–∞–ø—Ä–∏–º–µ—Ä: "–ø–æ—Å–ª–∞—Ç—å –Ω–∞ —Ö—É–π", "–∫–∞–∫–æ–≥–æ —Ö—É—è", "–ø–∏–∑–¥–µ—Ü –∫–∞–∫ —É—Å—Ç–∞–ª–∞" –∏ —Ç.–¥.
- –ù–ï —É–ø–æ–º–∏–Ω–∞–π –∑–Ω–∞–∫–∏ –∑–æ–¥–∏–∞–∫–∞ –¥—Ä—É–≥–∏—Ö –ª—é–¥–µ–π –≤ —Ç–µ–∫—Å—Ç–µ (—Ç–∏–ø–∞ "–°–µ—Ä–≥–µ–π-–°—Ç—Ä–µ–ª–µ—Ü")
- –ù–ï –ø–∏—à–∏ "–û–≤–µ–Ω", "—Ç–≤–æ–π –∑–Ω–∞–∫", –¥–∞—Ç—ã ‚Äî —ç—Ç–æ —É–∂–µ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown (**, ##, ---)
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–∫–æ–Ω—á–∏ –ø–æ–ª–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º
- –§–∏–Ω–∞–ª: —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ-–æ–±–æ–¥—Ä—è—é—â–∏–π, —Ç–∏–ø–∞ "—Å–ø—Ä–∞–≤–∏—à—å—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ –≤—Å—ë –∏–¥—ë—Ç –∫ —Ö—É—è–º"
${weatherSummary ? `- –ü–æ–≥–æ–¥–∞ –Ω–∞ –Ω–µ–¥–µ–ª—é: ${weatherSummary}. –û–±—ã–≥—Ä–∞–π —ç—Ç–æ —è–∑–≤–∏—Ç–µ–ª—å–Ω–æ, –Ω–µ –Ω–∞–∑—ã–≤–∞—è –≥–æ—Ä–æ–¥.` : ''}
${cycleHint ? `- –¶–∏–∫–ª –ù–∞—Å—Ç–∏: ${cycleHint}` : ''}
${subtleHint ? `
‚ö†Ô∏è –í–ê–ñ–ù–ê–Ø –ú–´–°–õ–¨ –ù–ï–î–ï–õ–ò (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–ø–ª–µ—Ç–∏ –æ—Ä–≥–∞–Ω–∏—á–Ω–æ):
"${subtleHint}"
–ò–ù–°–¢–†–£–ö–¶–ò–Ø: –≠—Ç—É –º—ã—Å–ª—å –Ω—É–∂–Ω–æ –ù–ï–ó–ê–ú–ï–¢–ù–û –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –æ–¥–∏–Ω –∏–∑ –∞–±–∑–∞—Ü–µ–≤. –ù–ï —Ü–∏—Ç–∏—Ä—É–π –¥–æ—Å–ª–æ–≤–Ω–æ, –∞ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ —Å —Å–∞—Ä–∫–∞–∑–º–æ–º, —Å–æ—Ö—Ä–∞–Ω–∏–≤ —Å—É—Ç—å. –°–¥–µ–ª–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã —ç—Ç–æ –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —á–∞—Å—Ç—å –≥–æ—Ä–æ—Å–∫–æ–ø–∞, –∞ –Ω–µ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –Ω–∞—Å—Ç–∞–≤–ª–µ–Ω–∏–µ.` : ''}

${astroHighlights.length ? `–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ (–¥–ª—è —Ç–µ–±—è, –Ω–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π –∏—Ö —Å–ø–∏—Å–∫–æ–º, –∞ –≤–ø–ª–µ—Ç–∏ —Å–º—ã—Å–ª –≤ —Ç–µ–∫—Å—Ç):\n${astroHighlights.map((item, index) => `${index + 1}. ${item}`).join('\n')}\n` : ''}${weatherSummary ? `–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è —Ç–µ–±—è: –ø–æ–≥–æ–¥–∞ –Ω–∞ –Ω–µ–¥–µ–ª–µ ‚Äî ${weatherSummary}. –í —Ç–µ–∫—Å—Ç–µ –ø—Ä–æ—Å—Ç–æ —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ –Ω–∞–º–µ–∫–Ω–∏ –Ω–∞ —ç—Ç–∏ –ø–æ–≥–æ–¥–Ω—ã–µ –ø—Ä–∏–∫–æ–ª—ã, –º–µ—Å—Ç–æ –Ω–µ –Ω–∞–∑—ã–≤–∞–π.\n` : ''}${cycleHint ? `–ó–∞–ø–æ–º–Ω–∏: —Ü–∏–∫–ª —Ç–∞–∫–æ–π ‚Äî ${cycleHint}. –í —Ç–µ–∫—Å—Ç–µ –ø–æ–¥—á—ë—Ä–∫–Ω—É—Ç–æ –Ω–∞–º–µ–∫–Ω–∏ –Ω–∞ —ç—Ç–æ.` : ''}–ü–∏—à–∏ —Å—Ä–∞–∑—É —Ç–µ–∫—Å—Ç, –±–µ–∑ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π.`;
}

function buildDailyPrompt(
  isoDate: string,
  astroHighlights: string[],
  weatherSummary?: string | null,
  cycleHint?: string | null,
  memoryEntries?: HoroscopeMemoryEntry[],
): string {
  const date = new Date(isoDate);
  const formatter = new Intl.DateTimeFormat('ru-RU', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  });
  const formattedDate = formatter.format(date);
  const memoryReminders = buildDailyMemoryReminders(memoryEntries);

  // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–π –Ω–∞–º—ë–∫ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 20%
  const subtleHint = getSubtleHint(0.20);

  return `–°–æ—Å—Ç–∞–≤—å —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π –¥–Ω–µ–≤–Ω–æ–π –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –ù–∞—Å—Ç–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (–¥–∞—Ç–∞ –¥–ª—è —Ç–µ–±—è: ${formattedDate}, –Ω–æ –≤ —Ç–µ–∫—Å—Ç–µ –µ—ë –Ω–µ –Ω–∞–∑—ã–≤–∞–π).

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- 2 –∫–æ—Ä–æ—Ç–∫–∏—Ö –∞–±–∑–∞—Ü–∞ –ø–æ 2‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∫–∞–∂–¥—ã–π —Å —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —ç–º–æ–¥–∑–∏ –≤ –Ω–∞—á–∞–ª–µ
- –°–∞—Ä–∫–∞–∑–º –∏ –º–∞—Ç –Ω–∞ –º–µ—Å—Ç–µ, –∫–∞–∫ —É –ª—É—á—à–µ–π –ø–æ–¥—Ä—É–≥–∏, –Ω–æ –±–µ–∑ –ø–µ—Ä–µ–±–æ—Ä–∞
- –§–æ–∫—É—Å: –¥–µ–ª–∞ –¥–Ω—è, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –°–µ—Ä—ë–∂–µ–π, –±—ã—Ç–æ–≤–∞—è —Ä—É—Ç–∏–Ω–∞ –∏ —Ç–µ–ª–æ.
- –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—à—å –°–µ—Ä—ë–∂—É ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π —Ä–µ–∞–ª—å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –Ω–æ–≤—ã—Ö –ª—é–¥–µ–π –∏ –¥—Ä–∞–º.
${memoryReminders.length ? `${memoryReminders.join('\n')}\n` : ''}- –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∞–∫—Ç—ã –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø—Ä–∏–≤—è–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –∫ —Ä–µ–∞–ª—å–Ω—ã–º —Ç—Ä–∞–Ω–∑–∏—Ç–∞–º. –ù–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π –∏—Ö –∫–∞–∫ —Å–ø–∏—Å–æ–∫ –∏ –Ω–µ —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ "—Ç—Ä–∞–Ω–∑–∏—Ç" ‚Äî –ø—Ä–æ—Å—Ç–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–π —Å–º—ã—Å–ª.
- –ù–µ —É–ø–æ–º–∏–Ω–∞–π –ø—Ä–æ –Ω–µ–¥–µ–ª–∏, —Ç–æ–ª—å–∫–æ –ø—Ä–æ —ç—Ç–æ—Ç –¥–µ–Ω—å
- –§–∏–Ω–∞–ª ‚Äî –∂—ë—Å—Ç–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –∑–∞–∫–æ–Ω—á–µ–Ω–Ω–∞—è –º—ã—Å–ª—å
${weatherSummary ? `- –ü–æ–≥–æ–¥–∞ –Ω–∞ –¥–µ–Ω—å: ${weatherSummary}. –í–ø–ª–µ—Ç–∏ —ç—Ç–æ –≤ —Ç–µ–∫—Å—Ç —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ –∏ –±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≥–æ—Ä–æ–¥–∞.` : ''}
${cycleHint ? `- –¶–∏–∫–ª: ${cycleHint}` : ''}
${subtleHint ? `
‚ö†Ô∏è –í–ê–ñ–ù–ê–Ø –ú–´–°–õ–¨ –î–ù–Ø (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–ø–ª–µ—Ç–∏ –æ—Ä–≥–∞–Ω–∏—á–Ω–æ):
"${subtleHint}"
–ò–ù–°–¢–†–£–ö–¶–ò–Ø: –≠—Ç—É –º—ã—Å–ª—å –Ω—É–∂–Ω–æ –ù–ï–ó–ê–ú–ï–¢–ù–û –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –æ–¥–∏–Ω –∏–∑ –∞–±–∑–∞—Ü–µ–≤. –ù–ï —Ü–∏—Ç–∏—Ä—É–π –¥–æ—Å–ª–æ–≤–Ω–æ, –∞ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, —Å–æ—Ö—Ä–∞–Ω–∏–≤ —Å—É—Ç—å. –°–¥–µ–ª–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã —ç—Ç–æ –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —á–∞—Å—Ç—å –≥–æ—Ä–æ—Å–∫–æ–ø–∞, –∞ –Ω–µ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –Ω–∞—Å—Ç–∞–≤–ª–µ–Ω–∏–µ.` : ''}

${astroHighlights.length ? `–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ (–¥–ª—è —Ç–µ–±—è, –Ω–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π –∏—Ö –¥–æ—Å–ª–æ–≤–Ω–æ):
${astroHighlights.map((item, index) => `${index + 1}. ${item}`).join('\n')}
` : ''}${weatherSummary ? `–°–ø—Ä–∞–≤–∫–∞ –ø–æ –ø–æ–≥–æ–¥–µ: ${weatherSummary}. –ü—Ä–æ—Å—Ç–æ —Å–¥–µ–ª–∞–π –µ—Ö–∏–¥–Ω—ã–π –∑–∞—Ö–æ–¥ –≤ —Ç–µ–∫—Å—Ç–µ, –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—è –ª–æ–∫–∞—Ü–∏—é.\n` : ''}${cycleHint ? `–°–ø—Ä–∞–≤–∫–∞ –ø–æ —Ü–∏–∫–ª—É: ${cycleHint}. –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–± –ø–æ–¥–∫–æ–ª–æ—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ù–∞—Å—Ç—é.\n` : ''}${memoryReminders.length ? `–≠—Ç–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–æ –ø–æ–≤—Ç–æ—Ä—ã —É—á—Ç–∏, –Ω–æ –Ω–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π —è–≤–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–π —Å—é–∂–µ—Ç.` : ''}–ü–∏—à–∏ —Ü–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—Ä–∞–∑—É, –±–µ–∑ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π.`;
}

function buildSergeyDailyPrompt(
  isoDate: string,
  astroHighlights: string[],
  weatherSummary?: string | null,
  cycleHint?: string | null,
  memoryEntries?: HoroscopeMemoryEntry[],
): string {
  const date = new Date(isoDate);
  const formatter = new Intl.DateTimeFormat('ru-RU', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  });
  const formattedDate = formatter.format(date);
  const memoryReminders = buildSergeyMemoryReminders(memoryEntries);

  // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–π –Ω–∞–º—ë–∫ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 25% (—á—É—Ç—å –≤—ã—à–µ –¥–ª—è –≥–æ—Ä–æ—Å–∫–æ–ø–∞ –°–µ—Ä–≥–µ—è)
  const subtleHint = getSubtleHint(0.25);

  return `–°–æ—Å—Ç–∞–≤—å –µ–¥–∫–∏–π –¥–Ω–µ–≤–Ω–æ–π –≥–æ—Ä–æ—Å–∫–æ–ø –ø—Ä–æ –°–µ—Ä–≥–µ—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (–¥–ª—è —Ç–µ–±—è –¥–∞—Ç–∞: ${formattedDate}, –Ω–æ –Ω–µ –ø–∏—à–∏ –µ—ë –≤ —Ç–µ–∫—Å—Ç–µ).

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –û–¥–∏–Ω —Ü–µ–ª—å–Ω—ã–π –∞–±–∑–∞—Ü –∏–∑ 3‚Äì4 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –Ω–∞—á–Ω–∏ –µ–≥–æ —Å –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —ç–º–æ–¥–∑–∏ –∏ –ø—Ä–æ–±–µ–ª–∞.
- –ü–∏—à–∏ –¥–ª—è –ù–∞—Å—Ç–∏, –ø—Ä–æ –°–µ—Ä—ë–∂—É –≤ –¢–†–ï–¢–¨–ï–ú –õ–ò–¶–ï: ¬´—É –Ω–µ–≥–æ¬ª, ¬´–µ–º—É¬ª, ¬´–µ–≥–æ¬ª, ¬´–æ–Ω¬ª. –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –∏–º—è ¬´–°–µ—Ä—ë–∂–∞¬ª –∫–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è.
- –ù–∞—Å—Ç—é —É–ø–æ–º–∏–Ω–∞–π –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –µ—Å—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ–≤–æ–¥, –ë–ï–ó —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑ —Ç–∏–ø–∞ ¬´—Ç—ã –∂–µ, –ù–∞—Å—Ç—è, –¥–µ—Ä–∂–∏—à—å—Å—è –º–æ–ª–æ–¥—Ü–æ–º¬ª. –ú–æ–∂–Ω–æ –≤–æ–æ–±—â–µ –Ω–µ —É–ø–æ–º–∏–Ω–∞—Ç—å, –µ—Å–ª–∏ –≥–æ—Ä–æ—Å–∫–æ–ø —Ç–æ–ª—å–∫–æ –ø—Ä–æ –Ω–µ–≥–æ.
- –¢–æ–Ω: –∫–æ–ª–∫–∏–π, —Å –º–∞—Ç–æ–º –ø–æ –¥–µ–ª—É; –Ω–∏–∫–∞–∫–æ–≥–æ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–≥–æ –æ–ø—Ç–∏–º–∏–∑–º–∞ –¥–ª—è –°–µ—Ä—ë–∂–∏.
- –§–∏–Ω–∞–ª ‚Äî —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ-–∂—ë—Å—Ç–∫–∏–π, –±–µ–∑ –ª—É—á–∏–∫–∞ –Ω–∞–¥–µ–∂–¥—ã.
- –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–æ–≤—ã—Ö —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ –∏ –¥–µ—Ç–µ–π ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –°–µ—Ä—ë–∂–∏ –∏ –µ–≥–æ –±—ã—Ç–æ–≤—ã—Ö –º–∏—Å—Å–∏–π.
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –±–∞—Ä–¥–∞–∫: —É –°–µ—Ä—ë–∂–∏ –ø–æ—Ä—è–¥–æ–∫ –∏ —á–∏—Å—Ç–æ—Ç–∞, —à—É—Ç–∏ –Ω–∞ –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞—Ö (–ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º, –∫–æ—Ñ–µ, –æ—Ñ–∏—Å, –≤–µ–ª–æ—Å–∏–ø–µ–¥, –∫–æ–Ω—Ç—Ä–æ–ª—å).
${memoryReminders.length ? `${memoryReminders.join('\n')}\n` : ''}${subtleHint ? `
‚ö†Ô∏è –ü–û–î–¢–ï–ö–°–¢ –î–ù–Ø (–≤–ø–ª–µ—Ç–∏ —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É –°–µ—Ä—ë–∂–∏):
"${subtleHint}"
–ò–ù–°–¢–†–£–ö–¶–ò–Ø: –≠—Ç–æ –º—ã—Å–ª—å, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –ø–æ–¥–∞—Ç—å —á–µ—Ä–µ–∑ –°–ï–†–ì–ï–Ø. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —Ä–µ—á—å –ø—Ä–æ –∑–∞–ø–∞—Ö–∏/—Å–≤–µ–∂–µ—Å—Ç—å ‚Äî —É–ø–æ–º—è–Ω–∏, —á—Ç–æ –û–ù –∑–∞–º–µ—á–∞–µ—Ç/—á—É–≤—Å—Ç–≤—É–µ—Ç; –µ—Å–ª–∏ –ø—Ä–æ –ø—Ä–∏–≤—ã—á–∫–∏ ‚Äî —á—Ç–æ –ï–ú–£ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è —Ç–µ—Ä–ø–µ—Ç—å –ø–∞—É–∑—ã; –µ—Å–ª–∏ –ø—Ä–æ –∑–¥–æ—Ä–æ–≤—å–µ ‚Äî —á—Ç–æ –û–ù –≤–∏–¥–∏—Ç –∫–∞—à–µ–ª—å. –°–¥–µ–ª–∞–π —ç—Ç–æ —á–∞—Å—Ç—å—é —Å–∞—Ä–∫–∞–∑–º–∞ –ø—Ä–æ –Ω–µ–≥–æ, –Ω–æ —á—Ç–æ–±—ã –ù–∞—Å—Ç—è –ü–û–ù–Ø–õ–ê –Ω–∞–º—ë–∫ –ø—Ä–æ —Å–µ–±—è.` : ''}
${astroHighlights.length ? `- –ò—Å–ø–æ–ª—å–∑—É–π –Ω–∏–∂–Ω–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∫–∞–∫ —Ñ–æ–Ω (–≤–ø–ª–µ—Ç–∞–π —Å–º—ã—Å–ª, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –¥–æ—Å–ª–æ–≤–Ω–æ):
${astroHighlights.map((item, index) => `${index + 1}. ${item}`).join('\n')}
` : ''}${weatherSummary ? `- –£ –Ω–µ–≥–æ –Ω–∞ —É–ª–∏—Ü–µ ${weatherSummary}. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–º–µ–∫–Ω–∏ –Ω–∞ –ø–æ–≥–æ–¥–Ω—ã–π –≤–∞–π–± –±–µ–∑ —Ü–∏—Ñ—Ä –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.` : ''}${cycleHint ? `- ${cycleHint}` : ''}- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏ –∏ markdown. –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç.`;
}

function isLikelyTruncated(text: string): boolean {
  const trimmed = text.trim();
  if (!trimmed) {
    return true;
  }

  const endings = '.!?‚Ä¶';
  const closingQuotes = '¬ª"‚Äù\'';

  const lastChar = trimmed.slice(-1);
  if (closingQuotes.includes(lastChar)) {
    const beforeQuote = trimmed.slice(0, -1).trim().slice(-1);
    if (beforeQuote && endings.includes(beforeQuote)) {
      return false;
    }
  }

  if (!endings.includes(lastChar)) {
    return true;
  }

  const sentences = trimmed.split(/[.!?‚Ä¶]/).map(part => part.trim()).filter(Boolean);
  if (sentences.length === 0) {
    return true;
  }
  const lastSentence = sentences[sentences.length - 1];
  return lastSentence.length < 20;
}

interface HoroscopeRequestOptions {
  signal?: AbortSignal;
  claudeApiKey?: string;
  claudeProxyUrl?: string;
  openAIApiKey?: string;
}

async function requestHoroscopeText(
  prompt: string,
  options: HoroscopeRequestOptions,
  baseMaxTokens = 700,
  retryMaxTokens = 950,
  systemPrompt: string = HOROSCOPE_SYSTEM_PROMPT,
): Promise<{ text: string; provider: 'claude' | 'openai' }>
{
  const { callAI } = await import('./aiClient');

  const makeMessages = (content: string): AIMessage[] => [
    {
      role: 'user',
      content,
    },
  ];

  const baseRequest: AIRequestOptions = {
    system: systemPrompt,
    messages: makeMessages(prompt),
    temperature: 0.85,
    maxTokens: baseMaxTokens,
    signal: options.signal,
    claudeApiKey: options.claudeApiKey,
    claudeProxyUrl: options.claudeProxyUrl,
    openAIApiKey: options.openAIApiKey,
  };

  let result = await callAI(baseRequest);
  let text = result.text.trim();

  if (!text || isLikelyTruncated(text)) {
    console.warn('[Horoscope] First attempt looks truncated, requesting rewrite with more tokens.');
    try {
      const retryRequest: AIRequestOptions = {
        ...baseRequest,
        maxTokens: retryMaxTokens,
        messages: makeMessages(
          `${prompt}\n\n–ü–µ—Ä–µ–ø–∏—à–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–Ω–æ–≤–æ. –ó–∞–≤–µ—Ä—à–∏ –∫–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏ –≤–µ—Å—å —Ç–µ–∫—Å—Ç, –Ω–µ –æ—Å—Ç–∞–≤–ª—è–π –æ–±—Ä–µ–∑–∞–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑. –§–∏–Ω–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–∫–æ–Ω—á–µ–Ω–Ω–æ–π –º—ã—Å–ª—å—é.`,
        ),
      };
      const retryResult = await callAI(retryRequest);
      const retryText = retryResult.text.trim();
      if (retryText) {
        result = retryResult;
        text = retryText;
      }
    } catch (retryError) {
      console.warn('[Horoscope] Retry attempt failed:', retryError);
    }
  }

  if (!text) {
    throw new Error('AI returned empty horoscope text');
  }

  if (isLikelyTruncated(text)) {
    console.warn('[Horoscope] Horoscope still appears truncated after retry.');
  }

  return {
    text,
    provider: result.provider,
  };
}

export async function fetchDailyHoroscope(
  isoDate: string,
  signal?: AbortSignal,
  claudeApiKey?: string,
  claudeProxyUrl?: string,
  openAIApiKey?: string,
  cycles?: CycleData[],
): Promise<DailyHoroscope> {
  try {
    const astroHighlights = buildAstroHighlights(isoDate);
    const weatherSummary = await fetchWeeklyWeatherSummary(isoDate, signal);
    const cycleHint = cycles ? buildWeeklyCycleHint(cycles, isoDate) : null;
    const prompt = buildWeeklyPrompt(isoDate, astroHighlights, weatherSummary, cycleHint);
    if (astroHighlights.length > 0) {
      console.log('[Horoscope] Astro highlights:', astroHighlights);
    }

    const result = await requestHoroscopeText(prompt, {
      signal,
      claudeApiKey,
      claudeProxyUrl,
      openAIApiKey,
    });

    console.log(`Generated weekly horoscope using ${result.provider}`);

    return {
      text: result.text,
      date: isoDate ?? null,
      provider: result.provider,
      weekRange: getWeekRange(isoDate),
      highlights: astroHighlights,
    };
  } catch (error) {
    console.error('Failed to generate AI horoscope:', error);
    return {
      text: '–°–µ–≥–æ–¥–Ω—è –≥–æ—Ä–æ—Å–∫–æ–ø —Å–ø—Ä—è—Ç–∞–ª—Å—è –∑–∞ –æ–±–ª–∞–∫–∞–º–∏, –Ω–æ –ù–∞—Å—Ç—è —É–≤–µ—Ä–µ–Ω–∞: —á—Ç–æ –±—ã –Ω–∏ —Å–ª—É—á–∏–ª–æ—Å—å, —Ç—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è! üíñ',
      date: isoDate ?? null,
      provider: 'fallback',
      highlights: [],
    };
  }
}

const FALLBACK_LOADING_MESSAGES: HoroscopeLoadingMessage[] = [
  { emoji: '‚òéÔ∏è', text: '–ó–≤–æ–Ω–∏–º –ú–∞—Ä—Å—É ‚Äî –≤—ã—è—Å–Ω—è–µ–º, –∫—Ç–æ —Å–µ–≥–æ–¥–Ω—è –∑–∞–≤–µ–¥—É–µ—Ç —Ç–≤–æ–∏–º –¥—Ä–∞–π–≤–æ–º.' },
  { emoji: 'üíå', text: '–ß–µ—Ä–µ–∑ –í–µ–Ω–µ—Ä—É —à–ª—ë–º –ø–∏—Å—å–º–æ ‚Äî —É—Ç–æ—á–Ω—è–µ–º, —Å–∫–æ–ª—å–∫–æ –Ω–µ–∂–Ω–æ—Å—Ç–∏ –≤—ã–¥–µ–ª–µ–Ω–æ –Ω–∞ –¥–µ–Ω—å.' },
  { emoji: 'üõ∞Ô∏è', text: '–°–≤—è–∑—å —Å –Æ–ø–∏—Ç–µ—Ä–æ–º –ª–æ–≤–∏–º ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏–ª–µ—Ç–∏—Ç –ª–∏ —É–¥–∞—á–∞ –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è.' },
  { emoji: '‚òïÔ∏è', text: '–°–∞—Ç—É—Ä–Ω –¥–æ–ø–∏–≤–∞–µ—Ç –∫–æ—Ñ–µ –∏ –ø–∏—à–µ—Ç —Å–ø–∏—Å–æ–∫ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.' },
  { emoji: 'üßπ', text: '–ü–ª—É—Ç–æ–Ω –¥–µ–ª–∞–µ—Ç —É–±–æ—Ä–∫—É –≤ –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–∏ ‚Äî –æ—Å—Ç–∞–≤—å –µ–º—É –ø–∞—Ä—É –º–∏–Ω—É—Ç —Ö–∞–æ—Å–∞.' },
  { emoji: 'üåï', text: '–õ—É–Ω–∞ –ø—Ä–∏–º–µ—Ä—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ‚Äî –ø–æ–¥–±–∏—Ä–∞–µ—Ç —Ç–µ–±–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥—Ä–∞–º–∞—Ç–∏–∑–º–∞.' },
];

export async function fetchHoroscopeLoadingMessages(
  claudeApiKey?: string,
  claudeProxyUrl?: string,
  openAIApiKey?: string,
  signal?: AbortSignal,
): Promise<HoroscopeLoadingMessage[]> {
  const prompt = `–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 6 —Å–º–µ—à–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –æ —Ç–æ–º, —á—Ç–æ –∏–¥—ë—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ä–æ—Å–∫–æ–ø–∞. –ö–∞–∂–¥—ã–π —Å—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω:
- –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –æ–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —ç–º–æ–¥–∑–∏;
- –±—ã—Ç—å –¥–ª–∏–Ω–æ–π 8-14 —Å–ª–æ–≤;
- —É–ø–æ–º–∏–Ω–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω–µ—Ç—ã –∏–ª–∏ –Ω–µ–±–µ—Å–Ω—ã–µ —Ç–µ–ª–∞ (–ú–∞—Ä—Å, –í–µ–Ω–µ—Ä–∞, –°–∞—Ç—É—Ä–Ω, –ü–ª—É—Ç–æ–Ω, –Æ–ø–∏—Ç–µ—Ä, –õ—É–Ω–∞, –°–æ–ª–Ω—Ü–µ –∏ —Ç.–¥.);
- –∑–≤—É—á–∞—Ç—å —Ç–∞–∫, –±—É–¥—Ç–æ –ù–∞—Å—Ç—è –∏—Ä–æ–Ω–∏—á–Ω–æ –æ–±—ä—è—Å–Ω—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–∑–≤–æ–Ω–∏–º –ú–∞—Ä—Å—É¬ª, ¬´–∂–¥—ë–º –æ—Ç–≤–µ—Ç –æ—Ç –í–µ–Ω–µ—Ä—ã¬ª);
- –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è –ø–æ —Å–º—ã—Å–ª—É –∏ —Ç–æ–Ω—É;
- –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–∏—Å–∫–∏, –∫–∞–≤—ã—á–∫–∏ –∏–ª–∏ —Å–ª–æ–≤–æ ¬´—Å—Ç–∞—Ç—É—Å¬ª.

–í–µ—Ä–Ω–∏ —Å—Ç—Ä–æ–≥–æ JSON-–º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤–∏–¥–∞ [{"emoji":"‚ú®","text":"..."}] –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.`;

  try {
    const { callAI } = await import('./aiClient');
    const response = await callAI({
      system: '–¢—ã –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—à—å –æ—Å—Ç—Ä–æ—É–º–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ JSON-–º–∞—Å—Å–∏–≤–æ–º.',
      messages: [
        {
          role: 'user',
          content: prompt,
        },
      ],
      temperature: 0.95,
      maxTokens: 320,
      signal,
      claudeApiKey,
      claudeProxyUrl,
      openAIApiKey,
    });

    const cleaned = response.text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
    const parsed = JSON.parse(cleaned) as HoroscopeLoadingMessage[];

    if (!Array.isArray(parsed) || parsed.length === 0) {
      throw new Error('Empty loading messages array');
    }

    return parsed
      .filter(entry => entry && typeof entry.emoji === 'string' && typeof entry.text === 'string')
      .map(entry => ({
        emoji: entry.emoji.trim(),
        text: entry.text.trim(),
      }))
      .filter(entry => entry.emoji && entry.text)
      .slice(0, 6);
  } catch (error) {
    console.warn('Failed to fetch custom loading messages, using fallback:', error);
    return FALLBACK_LOADING_MESSAGES;
  }
}

export async function fetchSergeyLoadingMessages(
  claudeApiKey?: string,
  claudeProxyUrl?: string,
  openAIApiKey?: string,
  signal?: AbortSignal,
): Promise<HoroscopeLoadingMessage[]> {
  const prompt = `–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 10 —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ—Å–∫–æ–ø–∞ –°–µ—Ä—ë–∂–∏.
–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ö–ê–ñ–î–û–ì–û —Å—Ç–∞—Ç—É—Å–∞:
- –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –æ–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —ç–º–æ–¥–∑–∏ –∏ –ø—Ä–æ–±–µ–ª–∞;
- –æ–¥–Ω–æ —ë–º–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (12‚Äì20 —Å–ª–æ–≤), –ë–ï–ó —Ç–æ—á–µ–∫ –≤–Ω—É—Ç—Ä–∏, –ë–ï–ó –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫;
- —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ –Ω–∞–º–µ–∫–∞–µ—Ç, —á—Ç–æ –°–µ—Ä—ë–∂–∞ —Å–Ω–æ–≤–∞ –ø—Ä–∏—Ç–≤–æ—Ä—è–µ—Ç—Å—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–º (—Å –æ—Ç—Å—ã–ª–∫–∞–º–∏ –∫ –ø–ª–∞–Ω–µ—Ç–∞–º, –∫–æ—Å–º–æ—Å—É, –Ω–µ–±–µ—Å–Ω–æ–π –±—é—Ä–æ–∫—Ä–∞—Ç–∏–∏);
- –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ª—ë–≥–∫–∏–π –º–∞—Ç —Ç–∏–ø–∞ ¬´–Ω–∞—Ö—Ä–µ–Ω–∞¬ª, –Ω–æ –∏–∑–±–µ–≥–∞–π –∂—ë—Å—Ç–∫–æ–π –±—Ä–∞–Ω–∏;
- –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è —Å–º—ã—Å–ª–æ–º –∏ –æ–±—Ä–∞–∑–∞–º–∏;
- –í–ê–ñ–ù–û: –≤–µ—Å—å —Ç–µ–∫—Å—Ç –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É, –ë–ï–ó –ø–µ—Ä–µ–Ω–æ—Å–æ–≤, –≤—Å–µ –∫–∞–≤—ã—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—Å—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã.

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON-–º–∞—Å—Å–∏–≤ –≤–∏–¥–∞ [{"emoji":"‚ú®","text":"..."}] –ë–ï–ó markdown, –ë–ï–ó –ø–æ—è—Å–Ω–µ–Ω–∏–π, –ë–ï–ó –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ –≤–Ω—É—Ç—Ä–∏ text.`;

  try {
    const { callAI } = await import('./aiClient');
    const response = await callAI({
      system: '–¢—ã —è–∑–≤–∏—Ç–µ–ª—å–Ω–æ –æ–±—ä—è—Å–Ω—è–µ—à—å, –ø–æ—á–µ–º—É –≥–æ—Ä–æ—Å–∫–æ–ø –°–µ—Ä—ë–∂–∏ –µ—â—ë –≥—Ä—É–∑–∏—Ç—Å—è. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ JSON.',
      messages: [
        {
          role: 'user',
          content: prompt,
        },
      ],
      temperature: 0.7,
      maxTokens: 600,
      signal,
      claudeApiKey,
      claudeProxyUrl,
      openAIApiKey,
    });

    let cleaned = response.text.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞: —É–±—Ä–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –≤–Ω—É—Ç—Ä–∏ JSON
    cleaned = cleaned.replace(/\n/g, ' ').replace(/\r/g, '');

    const parsed = JSON.parse(cleaned) as HoroscopeLoadingMessage[];

    if (!Array.isArray(parsed) || parsed.length === 0) {
      throw new Error('Empty Sergey loading messages array');
    }

    return parsed
      .filter(entry => entry && typeof entry.emoji === 'string' && typeof entry.text === 'string')
      .map(entry => ({
        emoji: entry.emoji.trim(),
        text: entry.text.replace(/\s+/g, ' ').trim(),
      }))
      .filter(entry => entry.emoji && entry.text)
      .slice(0, 10);
  } catch (error) {
    console.warn('Failed to fetch Sergey loading messages, using fallback:', error);
    return getSergeyLoadingFallback();
  }
}

export async function fetchDailyHoroscopeForDate(
  isoDate: string,
  signal?: AbortSignal,
  claudeApiKey?: string,
  claudeProxyUrl?: string,
  openAIApiKey?: string,
  cycles?: CycleData[],
  memory?: HoroscopeMemoryEntry[],
): Promise<DailyHoroscope> {
  try {
    const astroHighlights = buildAstroHighlights(isoDate, 3);
    const weatherSummary = await fetchDailyWeatherSummary(isoDate, signal);
    const cycleHint = cycles ? buildDailyCycleHint(cycles, isoDate) : null;
    const prompt = buildDailyPrompt(isoDate, astroHighlights, weatherSummary, cycleHint, memory);
    if (astroHighlights.length > 0) {
      console.log('[Horoscope] Daily astro highlights:', astroHighlights);
    }

    const requestOptions: HoroscopeRequestOptions = {
      signal,
      claudeApiKey,
      claudeProxyUrl,
      openAIApiKey,
    };

    const result = await requestHoroscopeText(prompt, requestOptions, 600, 850);

    let memoryEntry: HoroscopeMemoryEntry | undefined;
    if (result.text) {
      const extracted = await extractHoroscopeMemoryEntry(result.text, isoDate, 'daily', requestOptions);
      if (extracted) {
        memoryEntry = extracted;
      }
    }

    console.log(`Generated daily horoscope using ${result.provider}`);

    return {
      text: result.text,
      date: isoDate ?? null,
      provider: result.provider,
      highlights: astroHighlights,
      memoryEntry,
    };
  } catch (error) {
    console.error('Failed to generate daily horoscope:', error);
    return {
      text: '–°–µ–≥–æ–¥–Ω—è –∑–≤—ë–∑–¥—ã –∑–∞–Ω—è—Ç—ã —Å–≤–æ–∏–º–∏ –¥–µ–ª–∞–º–∏, –Ω–æ –ù–∞—Å—Ç—è —É–≤–µ—Ä–µ–Ω–∞, —á—Ç–æ —Ç—ã –≤—ã–¥–µ—Ä–∂–∏—à—å —ç—Ç–æ—Ç –¥–µ–Ω—å! ‚ú®',
      date: isoDate ?? null,
      provider: 'fallback',
      highlights: [],
    };
  }
}

export async function fetchSergeyDailyHoroscopeForDate(
  isoDate: string,
  signal?: AbortSignal,
  claudeApiKey?: string,
  claudeProxyUrl?: string,
  openAIApiKey?: string,
  cycles?: CycleData[],
  memory?: HoroscopeMemoryEntry[],
): Promise<DailyHoroscope> {
  try {
    const allHighlights = buildAstroHighlights(isoDate, 6);
    const sergeySpecific = allHighlights.filter(
      entry => /–°–µ—Ä—ë–∂/i.test(entry) || /–≤–∞—à–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π/i.test(entry) || /–°–µ—Ä–≥–µ[–π—è]/i.test(entry),
    );
    const astroHighlights = sergeySpecific.length > 0 ? sergeySpecific : allHighlights.slice(0, 3);
    const rawWeatherSummary = await fetchDailyWeatherSummary(isoDate, signal);
    const weatherSummary = simplifyWeatherSummary(rawWeatherSummary);
    const cycleHint = cycles ? buildSergeyCycleHint(cycles, isoDate) : null;
    const prompt = buildSergeyDailyPrompt(isoDate, astroHighlights, weatherSummary, cycleHint, memory);

    const requestOptions: HoroscopeRequestOptions = {
      signal,
      claudeApiKey,
      claudeProxyUrl,
      openAIApiKey,
    };

    const result = await requestHoroscopeText(
      prompt,
      requestOptions,
      520,
      680,
      SERGEY_SYSTEM_PROMPT,
    );

    let memoryEntry: HoroscopeMemoryEntry | undefined;
    if (result.text) {
      const extracted = await extractHoroscopeMemoryEntry(result.text, isoDate, 'sergey', requestOptions);
      if (extracted) {
        memoryEntry = extracted;
      }
    }

    console.log(`Generated Sergey daily horoscope using ${result.provider}`);

    return {
      text: result.text,
      date: isoDate ?? null,
      provider: result.provider,
      highlights: astroHighlights,
      memoryEntry,
    };
  } catch (error) {
    console.error('Failed to generate Sergey daily horoscope:', error);
    return {
      text: 'ü§¶‚Äç‚ôÇÔ∏è –ó–≤—ë–∑–¥—ã –ø–æ–∂–∞–ª–∏ –ø–ª–µ—á–∞–º–∏: –°–µ—Ä—ë–∂–∞ –æ–ø—è—Ç—å —Ç–∞—â–∏—Ç –±—ã—Ç –æ–¥–∏–Ω, –∏ –Ω–∏–∫–∞–∫–æ–π —Å–≤–µ—Ç –≤ –∫–æ–Ω—Ü–µ —Ç–æ–Ω–Ω–µ–ª—è –¥–∞–∂–µ –Ω–µ –º–∏–≥–∞–µ—Ç.',
      date: isoDate ?? null,
      provider: 'fallback',
      highlights: [],
    };
  }
}

const SERGEY_BANNER_SYSTEM_PROMPT = `–¢—ã ‚Äî —è–∑–≤–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä—à–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–º–æ–≥–∞–µ—Ç –ù–∞—Å—Ç–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–æ –°–µ—Ä—ë–∂—É. –û—Ç–≤–µ—á–∞–π –ª–µ–≥–∫–æ, –ø–æ-—Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º—É –∏ –±–µ–∑ –ø–∞—Ñ–æ—Å–∞.`;

function buildSergeyBannerPrompt(
  isoDate: string,
  memoryEntries?: HoroscopeMemoryEntry[],
): string {
  const parsedDate = new Date(isoDate);
  const formattedDate = Number.isNaN(parsedDate.getTime())
    ? '—Å–µ–≥–æ–¥–Ω—è'
    : new Intl.DateTimeFormat('ru-RU', {
        day: 'numeric',
        month: 'long',
      }).format(parsedDate);

  const memoryReminders = buildSergeyMemoryReminders(memoryEntries);
  const remindersSection = memoryReminders.length
    ? `–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —Ç–æ–Ω—É –∏ —Ç–µ–º–∞–º:\n${memoryReminders.join('\n')}\n`
    : '';

  return `–ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç—ã –∫–∞—Ä—Ç–æ—á–∫–∏ ¬´–ß—Ç–æ —Ç–∞–º —É –°–µ—Ä—ë–∂–∏?¬ª –Ω–∞ ${formattedDate}.

–î–∞–π —á–µ—Ç—ã—Ä–µ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã —Å —Ç–µ–º –∂–µ —Å–º—ã—Å–ª–æ–º, –Ω–æ –≤ –Ω–æ–≤—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞—Ö:
- title ‚Äî –≤–æ–ø—Ä–æ—Å –Ω–∞ 4-7 —Å–ª–æ–≤ —Å –∏–Ω—Ç—Ä–∏–≥–æ–π –≤—Ä–æ–¥–µ ¬´–ê —á—Ç–æ —Ç–∞–º —É –°–µ—Ä—ë–∂–∏?¬ª (–æ—Å—Ç–∞–≤—å –∏–º—è –°–µ—Ä—ë–∂–∏ –≤ –ª—é–±–æ–º –ø–∞–¥–µ–∂–µ).
- subtitle ‚Äî –æ–¥–Ω–æ –ø–ª–æ—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–¥–æ 22 —Å–ª–æ–≤) —Å –ª—ë–≥–∫–∏–º —Å–∞—Ä–∫–∞–∑–º–æ–º –ø—Ä–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å; –ë–ï–ó –∫–ª–∏—à–µ —Ç–∏–ø–∞ ¬´—Å–Ω–æ–≤–∞ –º—É—Ç–∏—Ç¬ª, ¬´–æ–ø—è—Ç—å –∑–∞—Ç–µ–≤–∞–µ—Ç¬ª, ¬´–≥–æ—Ä–æ—Å–∫–æ–ø –≤—Å—ë —Ä–∞—Å—Å–∫–∞–∂–µ—Ç¬ª, ¬´—É–∑–Ω–∞–µ–º –ø—Ä–∞–≤–¥—É¬ª. –ü—Ä–∏–¥—É–º–∞–π —Å–≤–µ–∂—É—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É –ø—Ä–æ —Ç–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —É –Ω–µ–≥–æ —Å–µ–≥–æ–¥–Ω—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ö–∞–∂–µ—Ç—Å—è, —Å–µ–≥–æ–¥–Ω—è –æ–Ω –≥–æ—Ç–æ–≤ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å...¬ª, ¬´–£ –Ω–µ–≥–æ —Ç–∞–∫–æ–π –¥–µ–Ω—å, –∫–æ–≥–¥–∞...¬ª, ¬´–ï—Å—Ç—å –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–µ, —á—Ç–æ –ø–ª–∞–Ω—ã...¬ª).
- primaryButton ‚Äî 2-3 —Å–ª–æ–≤–∞, –ø—Ä–∏–∑—ã–≤ –∑–∞–≥–ª—è–Ω—É—Ç—å –≤ –≥–æ—Ä–æ—Å–∫–æ–ø.
- secondaryButton ‚Äî 1-2 —Å–ª–æ–≤–∞, –∏–≥—Ä–∞—é—â–∞—è –æ—Ç–º–∞–∑–∫–∞ –≤ –¥—É—Ö–µ ¬´–ú–Ω–µ –ø–æ—Ñ–∏–≥¬ª.

–ü—Ä–∞–≤–∏–ª–∞:
- –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Ä—É—Å—Å–∫–∏–π, –º–æ–∂–Ω–æ –ª—ë–≥–∫–∏–π —Å–∞—Ä–∫–∞–∑–º, –Ω–æ –±–µ–∑ –º–∞—Ç–∞ –∏ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π.
- –ù–∏–∫–∞–∫–∏—Ö —ç–º–æ–¥–∑–∏ –∏ –∫–∞–≤—ã—á–µ–∫.
- –ü–æ–¥–ø–∏—Å–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö –±–µ–∑ —Ç–æ—á–∫–∏ –Ω–∞ –∫–æ–Ω—Ü–µ.
- –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å, –Ω–æ –ë–ï–ó –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —à–∞–±–ª–æ–Ω–æ–≤.
- –ù–µ —É–ø–æ–º–∏–Ω–∞–π –ø—Ä—è–º–æ –ù–∞—Å—Ç—é –∏ –Ω–µ –æ–±—Ä–∞—â–∞–π—Å—è –∫ —á–∏—Ç–∞—Ç–µ–ª—å–Ω–∏—Ü–µ –Ω–∞ ¬´—Ç—ã¬ª ‚Äî –¥–µ–ª–∞–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –æ–±–µ–∑–ª–∏—á–µ–Ω–Ω—ã–º–∏ (¬´–ö–∞–∂–µ—Ç—Å—è, –°–µ—Ä—ë–∂–∞‚Ä¶¬ª, ¬´–ï—Å—Ç—å –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–µ, —á—Ç–æ‚Ä¶¬ª).
${remindersSection}–í–µ—Ä–Ω–∏ —Ä–æ–≤–Ω–æ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É JSON –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:
{"title":"...","subtitle":"...","primaryButton":"...","secondaryButton":"..."}
`;
}

export async function fetchSergeyBannerCopy(
  isoDate: string,
  signal?: AbortSignal,
  claudeApiKey?: string,
  claudeProxyUrl?: string,
  openAIApiKey?: string,
  memory?: HoroscopeMemoryEntry[],
): Promise<SergeyBannerCopy> {
  const prompt = buildSergeyBannerPrompt(isoDate, memory);

  try {
    const { callAI } = await import('./aiClient');
    const response = await callAI({
      system: SERGEY_BANNER_SYSTEM_PROMPT,
      messages: [
        {
          role: 'user',
          content: prompt,
        },
      ],
      temperature: 0.75,
      maxTokens: 220,
      signal,
      claudeApiKey,
      claudeProxyUrl,
      openAIApiKey,
    });

    const cleaned = response.text.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();
    const parsed = JSON.parse(cleaned) as Partial<SergeyBannerCopy>;

    const normalize = (value: unknown): string =>
      typeof value === 'string' ? value.replace(/\s+/g, ' ').trim() : '';

    const result: SergeyBannerCopy = {
      title: normalize(parsed.title),
      subtitle: normalize(parsed.subtitle),
      primaryButton: normalize(parsed.primaryButton),
      secondaryButton: normalize(parsed.secondaryButton),
    };

    if (!result.title || !result.subtitle || !result.primaryButton || !result.secondaryButton) {
      throw new Error('Sergey banner copy is incomplete');
    }

    console.log('[Horoscope] Generated Sergey banner copy using', response.provider);
    return result;
  } catch (error) {
    console.error('Failed to fetch Sergey banner copy:', error);
    throw error instanceof Error ? error : new Error(String(error));
  }
}

async function extractHoroscopeMemoryEntry(
  text: string,
  isoDate: string,
  source: HoroscopeMemoryEntry['source'],
  options: HoroscopeRequestOptions,
): Promise<HoroscopeMemoryEntry | null> {
  if (!text.trim()) {
    return null;
  }

  try {
    const { callAI } = await import('./aiClient');
    const prompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–Ω–µ–≤–Ω–æ–π –≥–æ—Ä–æ—Å–∫–æ–ø (–∏—Å—Ç–æ—á–Ω–∏–∫: ${source}) –∏ –∫—Ä–∞—Ç–∫–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–π, –æ —á—ë–º –æ–Ω.

–¢–µ–∫—Å—Ç:
"""
${text}
"""

–í–µ—Ä–Ω–∏ JSON –≤–∏–¥–∞ {
  "summary": "–æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –æ–±—ä—è—Å–Ω—è—é—â–µ–µ –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç/—Å—é–∂–µ—Ç",
  "keyThemes": ["2-4 –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ–º—ã –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Ñ—Ä–∞–∑–∞–º–∏"],
  "avoidPhrases": ["1-3 –≤–Ω—è—Ç–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Å—Ç–æ–∏—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å –¥–æ—Å–ª–æ–≤–Ω–æ –∑–∞–≤—Ç—Ä–∞"],
  "tone": "positive | neutral | negative | mixed"
}

–ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, —Ç–æ–ª—å–∫–æ JSON.`;

    const response = await callAI({
      system: '–¢—ã –≤—ã–¥–µ–ª—è–µ—à—å –∑–∞–º–µ—Ç–∫–∏ –æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–∏ –≥–æ—Ä–æ—Å–∫–æ–ø–æ–≤. –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ JSON-–æ–±—ä–µ–∫—Ç–æ–º.',
      messages: [
        {
          role: 'user',
          content: prompt,
        },
      ],
      temperature: 0.2,
      maxTokens: 320,
      signal: options.signal,
      claudeApiKey: options.claudeApiKey,
      claudeProxyUrl: options.claudeProxyUrl,
      openAIApiKey: options.openAIApiKey,
    });

    const cleaned = response.text.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();
    const parsed = JSON.parse(cleaned) as {
      summary?: unknown;
      keyThemes?: unknown;
      avoidPhrases?: unknown;
      tone?: unknown;
    };

    const summary =
      typeof parsed.summary === 'string' && parsed.summary.trim().length > 0
        ? parsed.summary.trim()
        : '';
    if (!summary) {
      return null;
    }

    const keyThemes = Array.isArray(parsed.keyThemes)
      ? parsed.keyThemes
          .filter((item): item is string => typeof item === 'string' && item.trim().length > 0)
          .slice(0, 4)
          .map(item => item.trim())
      : [];

    const avoidPhrases = Array.isArray(parsed.avoidPhrases)
      ? parsed.avoidPhrases
          .filter((item): item is string => typeof item === 'string' && item.trim().length > 0)
          .slice(0, 3)
          .map(item => item.trim())
      : [];

    const tone =
      parsed.tone === 'positive' ||
      parsed.tone === 'neutral' ||
      parsed.tone === 'negative' ||
      parsed.tone === 'mixed'
        ? parsed.tone
        : 'mixed';

    const entry: HoroscopeMemoryEntry = {
      id: `${source}-${isoDate}`,
      source,
      date: isoDate,
      summary,
      keyThemes,
      avoidPhrases,
      tone,
      createdAt: new Date().toISOString(),
    };

    return entry;
  } catch (error) {
    console.warn('Failed to extract horoscope memory entry:', error);
    return null;
  }
}

export function mergeHoroscopeMemoryEntries(
  existing: HoroscopeMemoryEntry[],
  next: HoroscopeMemoryEntry,
  maxEntries = MAX_MEMORY_KEEP,
): HoroscopeMemoryEntry[] {
  const deduped = existing.filter(
    entry => !(entry.source === next.source && entry.date === next.date),
  );

  const merged = [...deduped, next].sort(
    (a, b) => new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime(),
  );

  if (merged.length > maxEntries) {
    return merged.slice(merged.length - maxEntries);
  }

  return merged;
}
