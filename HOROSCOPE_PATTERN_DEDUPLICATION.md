# Система дедупликации паттернов в гороскопах

## Проблема

Астрологические позиции планет меняются медленно (особенно дня в пределах недели), что приводит к повторению одних и тех же фраз и паттернов в ежедневных гороскопах. Например:

- "сегодня зато Сереже можете поймать волну"
- "зато Сереже сегодня можно поймать волну"
- "зато Сереже удастся поймать волну"

Это три разные фразы, но один и тот же **паттерн**: "зато Сереже" + "поймать волну".

## Решение

### 1. Система памяти гороскопов (`HoroscopeMemoryEntry`)

Каждый сгенерированный гороскоп анализируется и сохраняется в памяти:

```typescript
interface HoroscopeMemoryEntry {
  id: string;
  source: 'daily' | 'weekly' | 'sergey';
  date: string;
  summary: string;           // Краткое описание сюжета
  keyThemes: string[];       // Ключевые темы (2-4)
  avoidPhrases: string[];    // Паттерны для избегания (1-3)
  tone: 'positive' | 'neutral' | 'negative' | 'mixed';
  createdAt: string;
}
```

**Местоположение**: src/types/index.ts:21-30

### 2. Параметры запоминания

**Файл**: src/utils/horoscope.ts:116-167

```typescript
const MAX_MEMORY_KEEP = 12;          // Хранить максимум 12 записей
const DAILY_MEMORY_LOOKBACK = 7;     // Учитывать последние 7 дней (увеличено с 4)
```

### 3. Статические списки паттернов для избегания

#### Паттерны для гороскопов Насти

```typescript
const COMMON_REPEATED_PATTERNS_NASTIA = [
  'поймать волну',
  'зато Сереже',
  'зато Серёже',
  'просто дыши',
  'дыши и не парься',
  'отпусти и живи',
  'тело знает лучше',
  'слушай своё тело',
  'звёзды намекают',
  'планеты шепчут',
  'космос говорит',
  'вселенная подсказывает',
];
```

#### Паттерны для гороскопов Серёжи

```typescript
const COMMON_REPEATED_PATTERNS_SERGEY = [
  'Серёжа снова',
  'у него опять',
  'он снова',
  'как обычно',
  'по традиции',
  'в этот раз',
  'на сей раз',
  'очередной раз',
];
```

### 4. Извлечение паттернов из текста

**Функция**: `extractHoroscopeMemoryEntry()` (src/utils/horoscope.ts:1165-1262)

После генерации гороскопа AI анализирует его и извлекает:
- **summary**: краткое описание сюжета
- **keyThemes**: ключевые темы
- **avoidPhrases**: **паттерны** (2-4 слова), а не полные предложения

**Пример**:
```json
{
  "summary": "Гороскоп про взаимодействие с Серёжей и бытовые дела",
  "keyThemes": ["отношения с Серёжей", "рутина", "усталость"],
  "avoidPhrases": ["поймать волну", "зато Сереже", "просто дыши"],
  "tone": "mixed"
}
```

**Критически важно**: `avoidPhrases` должны быть короткими паттернами (2-4 слова), а не полными предложениями.

### 5. Использование памяти при генерации

**Функции**:
- `buildDailyMemoryReminders()` (src/utils/horoscope.ts:359-415) — для гороскопов Насти
- `buildSergeyMemoryReminders()` (src/utils/horoscope.ts:417-474) — для гороскопов Серёжи

Эти функции создают напоминания для AI:

1. **Статические паттерны**:
   ```
   - ИЗБЕГАЙ повторяющиеся конструкции: поймать волну, зато Сереже, просто дыши, ...
   ```

2. **Недавние темы** (последние 7 дней):
   ```
   - Из недавних дней уже звучало: 8 ноября — отношения с Серёжей / рутина; 7 ноября — усталость / планы
   ```

3. **Использованные фразы**:
   ```
   - Не повторяй дословно формулировки «поймать волну», «зато Сереже» — переупакуй мысли иначе.
   ```

4. **Использованные темы**:
   ```
   - Темы усталость, рутина, планы уже звучали. Придумай другой повод или конфликт.
   ```

### 6. Интеграция в промпты

Напоминания добавляются в промпты генерации:

**Для дневных гороскопов Насти** (src/utils/horoscope.ts:605-645):
```typescript
${memoryReminders.length ? `${memoryReminders.join('\n')}\n` : ''}
```

**Для дневных гороскопов Серёжи** (src/utils/horoscope.ts:647-684):
```typescript
${memoryReminders.length ? `${memoryReminders.join('\n')}\n` : ''}
```

## Как расширять систему

### Добавление новых паттернов

Если вы заметили новый повторяющийся паттерн, добавьте его в соответствующий список:

**Файл**: src/utils/horoscope.ts:143-167

```typescript
// Для гороскопов Насти
const COMMON_REPEATED_PATTERNS_NASTIA = [
  // ... существующие паттерны
  'ваш новый паттерн',  // ← добавить сюда
];

// Для гороскопов Серёжи
const COMMON_REPEATED_PATTERNS_SERGEY = [
  // ... существующие паттерны
  'ваш новый паттерн',  // ← добавить сюда
];
```

### Увеличение периода запоминания

Если нужно помнить больше дней (например, 10 вместо 7):

**Файл**: src/utils/horoscope.ts:117

```typescript
const DAILY_MEMORY_LOOKBACK = 10;  // Увеличить значение
```

**Внимание**: чем больше lookback, тем длиннее промпт → выше стоимость API-запроса.

### Увеличение количества хранимых записей

Если нужно хранить больше 12 записей:

**Файл**: src/utils/horoscope.ts:116

```typescript
const MAX_MEMORY_KEEP = 20;  // Увеличить значение
```

## Тестирование

Чтобы проверить, работает ли система:

1. Сгенерируйте несколько гороскопов подряд (ежедневно в течение недели)
2. Откройте DevTools → Application → Local Storage → `nastia-app-data`
3. Проверьте поле `horoscopeMemory`:

```json
{
  "horoscopeMemory": [
    {
      "id": "daily-2025-11-09",
      "source": "daily",
      "date": "2025-11-09",
      "summary": "Гороскоп про...",
      "keyThemes": ["тема1", "тема2"],
      "avoidPhrases": ["паттерн1", "паттерн2"],
      "tone": "mixed",
      "createdAt": "2025-11-09T10:00:00.000Z"
    }
  ]
}
```

4. Проверьте, что новые гороскопы **не повторяют** паттерны из `avoidPhrases`

## Ограничения

1. **AI не идеален**: Даже с напоминаниями AI может иногда повторять паттерны. Если паттерн появляется слишком часто — добавьте его в статический список.

2. **Короткий lookback**: 7 дней — компромисс между эффективностью и стоимостью API. Слишком большой lookback увеличит длину промпта и стоимость.

3. **Контекстные паттерны**: Некоторые паттерны зависят от контекста (например, "поймать волну" может быть уместным в разных сюжетах). Система избегает их полностью, что иногда может ограничивать AI.

## Связанные файлы

- **src/utils/horoscope.ts** — основная логика генерации и памяти
- **src/types/index.ts** — типы данных (`HoroscopeMemoryEntry`)
- **src/utils/storage.ts** — сохранение и загрузка памяти в localStorage
- **src/components/ModernNastiaApp.tsx** — интеграция с UI (использование памяти при генерации)

## История изменений

### 2025-11-09: Улучшение дедупликации паттернов

**Изменения**:
1. ✅ Увеличен `DAILY_MEMORY_LOOKBACK` с 4 до 7 дней
2. ✅ Добавлены списки `COMMON_REPEATED_PATTERNS_NASTIA` и `COMMON_REPEATED_PATTERNS_SERGEY`
3. ✅ Улучшен промпт `extractHoroscopeMemoryEntry()` для извлечения паттернов (не дословных фраз)
4. ✅ Обновлены функции `buildDailyMemoryReminders()` и `buildSergeyMemoryReminders()` для использования новых списков

**Мотивация**: Пользователь заметил повторение паттерна "зато Сереже поймать волну" каждый день. Система ловила только дословные совпадения, но не паттерны.

**Результат**: Теперь система избегает не только дословных фраз, но и ключевых конструкций (2-4 слова), которые AI склонен повторять.
